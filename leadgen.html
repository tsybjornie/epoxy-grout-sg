<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadGen AI ‚Äî CLEANGROUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0A;
            color: #fff;
            min-height: 100vh
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 30px
        }

        .header h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.02em
        }

        .header h1 span {
            color: #D32F2F
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .brain-score {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px
        }

        .brain-score span {
            color: #FFD700;
            font-weight: 800
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s
        }

        .btn-primary {
            background: #D32F2F;
            color: #fff
        }

        .btn-primary:hover {
            background: #B71C1C
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid #444;
            color: #fff
        }

        .btn-outline:hover {
            border-color: #fff
        }

        .btn-gold {
            background: #FFD700;
            color: #0A0A0A
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #111;
            padding: 4px;
            border-radius: 10px;
            width: fit-content
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            border: none;
            background: transparent;
            color: #777
        }

        .tab.active {
            background: #fff;
            color: #0A0A0A
        }

        .tab:hover:not(.active) {
            color: #fff
        }

        .tab-content {
            display: none
        }

        .tab-content.active {
            display: block
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px
        }

        .stat-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px
        }

        .stat-label {
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: 6px
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.02em
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px
        }

        .stat-up {
            color: #4CAF50
        }

        .stat-down {
            color: #D32F2F
        }

        /* A/B Test Cards */
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px
        }

        .test-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px;
            position: relative
        }

        .test-card.winner {
            border-color: #FFD700
        }

        .test-card.loser {
            opacity: .6
        }

        .test-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700
        }

        .badge-winner {
            background: #FFD700;
            color: #0A0A0A
        }

        .badge-running {
            background: #333;
            color: #fff
        }

        .badge-loser {
            background: #D32F2F;
            color: #fff
        }

        .test-variant {
            font-size: 11px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 8px
        }

        .test-copy {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
            color: #ccc
        }

        .test-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px
        }

        .test-metric {
            text-align: center
        }

        .test-metric-val {
            font-size: 20px;
            font-weight: 800
        }

        .test-metric-label {
            font-size: 11px;
            color: #777
        }

        .progress-bar {
            height: 6px;
            background: #222;
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .5s
        }

        .fill-a {
            background: #D32F2F
        }

        .fill-b {
            background: #4CAF50
        }

        /* Lead Log */
        .lead-table {
            width: 100%;
            border-collapse: collapse
        }

        .lead-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .05em;
            border-bottom: 1px solid #222
        }

        .lead-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid #1a1a1a
        }

        .lead-table tr:hover {
            background: #111
        }

        .channel-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700
        }

        .ch-fb {
            background: rgba(66, 103, 178, .2);
            color: #4267B2
        }

        .ch-ig {
            background: rgba(225, 48, 108, .2);
            color: #E1306C
        }

        .ch-goog {
            background: rgba(66, 133, 244, .2);
            color: #4285F4
        }

        .ch-wa {
            background: rgba(37, 211, 102, .2);
            color: #25D366
        }

        .ch-web {
            background: rgba(255, 215, 0, .2);
            color: #FFD700
        }

        .ch-mktp {
            background: rgba(255, 255, 255, .1);
            color: #fff
        }

        .status-hot {
            color: #D32F2F;
            font-weight: 700
        }

        .status-warm {
            color: #FF9800;
            font-weight: 700
        }

        .status-cold {
            color: #777
        }

        .status-booked {
            color: #4CAF50;
            font-weight: 700
        }

        /* Insights Panel */
        .insight-card {
            background: linear-gradient(135deg, #111, #1a1a1a);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px
        }

        .insight-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .insight-card p {
            font-size: 13px;
            color: #999;
            line-height: 1.6
        }

        .insight-card .action {
            margin-top: 12px;
            padding: 8px 16px;
            background: #D32F2F;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif
        }

        /* Add Lead Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.open {
            display: flex
        }

        .modal {
            background: #111;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 30px;
            width: 480px;
            max-width: 90vw
        }

        .modal h3 {
            margin-bottom: 20px;
            font-size: 18px
        }

        .form-group {
            margin-bottom: 16px
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #777;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: .05em
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: #0a0a0a;
            border: 1.5px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-family: 'Inter', sans-serif
        }

        .form-group textarea {
            height: 80px;
            resize: vertical
        }

        .form-group select option {
            background: #111
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px
        }

        /* Responsive */
        @media(max-width:768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr)
            }

            .test-grid {
                grid-template-columns: 1fr
            }

            .header {
                flex-direction: column;
                gap: 12px
            }
        }
    </style>
</head>

<body>
    <!-- PIN Lock Screen -->
    <div id="pinLock"
        style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0A0A0A;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px">
        <h2 style="font-family:'Inter',sans-serif;font-weight:800;font-size:24px;color:#fff">LeadGen <span
                style="color:#D32F2F">AI</span></h2>
        <p style="font-family:'Inter',sans-serif;color:#777;font-size:14px">Enter PIN to access</p>
        <input type="password" id="pinInput" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            style="width:200px;text-align:center;padding:14px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;font-size:24px;font-family:'Inter',sans-serif;letter-spacing:0.3em"
            onkeydown="if(event.key==='Enter')checkPin()">
        <button onclick="checkPin()"
            style="padding:12px 32px;background:#D32F2F;color:#fff;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-weight:700;font-size:14px;cursor:pointer">Unlock</button>
        <p id="pinError" style="font-family:'Inter',sans-serif;color:#D32F2F;font-size:13px;display:none">Wrong PIN</p>
    </div>

    <!-- Backup Reminder Banner -->
    <div id="backupBanner"
        style="display:none;background:#FF9800;color:#0A0A0A;padding:10px 20px;text-align:center;font-family:'Inter',sans-serif;font-size:13px;font-weight:600">
        ‚ö†Ô∏è You have <span id="backupCount"></span> leads stored in this browser only. <button
            onclick="exportData();this.parentElement.style.display='none'"
            style="background:#0A0A0A;color:#fff;border:none;padding:6px 14px;border-radius:4px;font-weight:700;cursor:pointer;font-size:12px;margin-left:8px">Export
            CSV Backup</button>
        <button onclick="this.parentElement.style.display='none';localStorage.setItem('lg_lastBackup',Date.now())"
            style="background:none;border:none;color:#0A0A0A;cursor:pointer;font-size:16px;margin-left:4px">&times;</button>
    </div>

    <div class="app">
        <div class="header">
            <h1>LeadGen <span>AI</span></h1>
            <div class="header-right">
                <div class="brain-score">üß† Brain Level: <span id="brainLevel">1</span></div>
                <button class="btn btn-outline" onclick="changePin()" style="font-size:11px;padding:8px 12px">üîí
                    PIN</button>
                <button class="btn btn-outline" onclick="exportData()">Export CSV</button>
                <button class="btn btn-primary" onclick="openModal()">+ Log Lead</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('ab')">A/B Tests</div>
            <div class="tab" onclick="switchTab('leads')">Lead Log</div>
            <div class="tab" onclick="switchTab('insights')">AI Insights</div>
            <div class="tab" onclick="switchTab('templates')">Ad Templates</div>
        </div>

        <!-- DASHBOARD -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="totalLeads">0</div>
                    <div class="stat-change stat-up" id="leadsChange">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-value" id="convRate">0%</div>
                    <div class="stat-change" id="convChange">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Channel</div>
                    <div class="stat-value" id="bestChannel" style="font-size:22px">‚Äî</div>
                    <div class="stat-change stat-up" id="bestChannelRate">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Revenue (Est.)</div>
                    <div class="stat-value" id="revenue">$0</div>
                    <div class="stat-change stat-up" id="revChange">‚Äî</div>
                </div>
            </div>
            <h3 style="margin-bottom:16px">üìä Channel Performance</h3>
            <div id="channelBreakdown"
                style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:30px"></div>
            <h3 style="margin-bottom:16px">‚ö° Recent Leads</h3>
            <div id="recentLeads"></div>
        </div>

        <!-- A/B TESTS -->
        <div class="tab-content" id="tab-ab">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3>üß™ Active A/B Tests</h3>
                <button class="btn btn-primary" onclick="createNewTest()">+ New Test</button>
            </div>
            <div id="abTests"></div>
            <h3 style="margin:30px 0 16px">üèÜ Completed Tests</h3>
            <div id="completedTests"></div>
        </div>

        <!-- LEADS -->
        <div class="tab-content" id="tab-leads">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3>üìã All Leads</h3>
                <div style="display:flex;gap:8px">
                    <select id="filterChannel" onchange="renderLeads()"
                        style="padding:8px 12px;background:#111;border:1px solid #333;border-radius:6px;color:#fff;font-size:13px">
                        <option value="all">All Channels</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Google">Google</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Website">Website</option>
                        <option value="Marketplace">Marketplace</option>
                    </select>
                </div>
            </div>
            <table class="lead-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Channel</th>
                        <th>Ad Copy</th>
                        <th>Status</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadTableBody"></tbody>
            </table>
        </div>

        <!-- AI INSIGHTS -->
        <div class="tab-content" id="tab-insights">
            <h3 style="margin-bottom:20px">üß† AI Analysis & Recommendations</h3>
            <div id="insightsPanel"></div>
        </div>

        <!-- AD TEMPLATES -->
        <div class="tab-content" id="tab-templates">
            <h3 style="margin-bottom:20px">üìù Ready-to-Use Templates</h3>
            <div id="templatesPanel"></div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal">
            <h3>Log New Lead</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="leadName" placeholder="Customer name">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="leadPhone" placeholder="+65 9XXX XXXX">
            </div>
            <div class="form-group">
                <label>Channel</label>
                <select id="leadChannel">
                    <option value="Facebook">Facebook</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Google">Google</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Website">Website (Chatbot)</option>
                    <option value="Marketplace">FB Marketplace</option>
                </select>
            </div>
            <div class="form-group">
                <label>Which Ad Copy Brought Them?</label>
                <select id="leadAdCopy"></select>
            </div>
            <div class="form-group">
                <label>Package Interest</label>
                <select id="leadPackage">
                    <option value="Bathroom">Bathroom ($439)</option>
                    <option value="Kitchen">Kitchen ($529)</option>
                    <option value="Full Home">Full Home ($1,339)</option>
                    <option value="Unsure">Not sure yet</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="leadStatus">
                    <option value="Hot">üî• Hot ‚Äî Ready to book</option>
                    <option value="Warm">üü° Warm ‚Äî Interested</option>
                    <option value="Cold">‚ö™ Cold ‚Äî Just enquiring</option>
                    <option value="Booked">‚úÖ Booked!</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="leadNotes" placeholder="Any details..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLead()">Save Lead</button>
            </div>
        </div>
    </div>

    <!-- New A/B Test Modal -->
    <div class="modal-overlay" id="abModal">
        <div class="modal">
            <h3>üß™ Create A/B Test</h3>
            <div class="form-group">
                <label>Test Name</label>
                <input type="text" id="testName" placeholder="e.g. FB Ad Copy - CNY vs Problem">
            </div>
            <div class="form-group">
                <label>Channel</label>
                <select id="testChannel">
                    <option value="Facebook">Facebook</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Google">Google</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Marketplace">FB Marketplace</option>
                </select>
            </div>
            <div class="form-group">
                <label>Variant A ‚Äî Copy</label>
                <textarea id="testCopyA" placeholder="First ad copy variation..."></textarea>
            </div>
            <div class="form-group">
                <label>Variant B ‚Äî Copy</label>
                <textarea id="testCopyB" placeholder="Second ad copy variation..."></textarea>
            </div>
            <div class="form-group">
                <label>Min Leads to Declare Winner</label>
                <select id="testMinLeads">
                    <option value="10">10 leads each</option>
                    <option value="20" selected>20 leads each</option>
                    <option value="30">30 leads each</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeABModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTest()">Start Test</button>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // PIN LOCK (#8)
        // ============================
        const DEFAULT_PIN = '1234';
        function checkPin() {
            const pin = document.getElementById('pinInput').value;
            const storedPin = localStorage.getItem('lg_pin') || DEFAULT_PIN;
            if (pin === storedPin) {
                document.getElementById('pinLock').style.display = 'none';
                showBackupReminder();
            } else {
                document.getElementById('pinError').style.display = 'block';
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').style.borderColor = '#D32F2F';
                setTimeout(() => { document.getElementById('pinInput').style.borderColor = '#333'; document.getElementById('pinError').style.display = 'none'; }, 1500);
            }
        }
        function changePin() {
            const newPin = prompt('Enter new PIN (4-6 digits):');
            if (newPin && /^\d{4,6}$/.test(newPin)) {
                localStorage.setItem('lg_pin', newPin);
                alert('PIN updated!');
            } else if (newPin) { alert('PIN must be 4-6 digits'); }
        }

        // ============================
        // BACKUP REMINDER (#7)
        // ============================
        function showBackupReminder() {
            const leads = getData('leads', []);
            const lastBackup = parseInt(localStorage.getItem('lg_lastBackup') || '0');
            const daysSinceBackup = (Date.now() - lastBackup) / 86400000;
            if (leads.length >= 10 && daysSinceBackup > 3) {
                document.getElementById('backupBanner').style.display = 'block';
                document.getElementById('backupCount').textContent = leads.length;
            }
        }

        // ============================
        // LEADGEN AI ‚Äî SELF-LEARNING ENGINE
        // ============================

        const PRICES = { Bathroom: 439, Kitchen: 529, 'Full Home': 1339, Unsure: 0 };

        // Data Store
        function getData(key, def) { return JSON.parse(localStorage.getItem('lg_' + key) || JSON.stringify(def)); }
        function setData(key, val) { localStorage.setItem('lg_' + key, JSON.stringify(val)); }

        let leads = getData('leads', []);
        let tests = getData('tests', getDefaultTests());
        let learnings = getData('learnings', { totalDecisions: 0, winPatterns: [] });

        // ============================
        // CONTENT BRAIN ‚Äî LEARNS WHAT TO POST
        // ============================
        const MSG_STYLES = {
            urgency: { keywords: ['limited', 'slots', 'left', 'ends', 'hurry', 'only', 'last'], label: '‚è∞ Urgency/Scarcity' },
            price: { keywords: ['$', 'off', 'discount', 'save', 'deal', 'special', 'promo', 'cheap'], label: 'üí∞ Price/Discount' },
            problem: { keywords: ['mold', 'stain', 'disgusting', 'dirty', 'ugly', 'crack', 'bacteria', 'scrub'], label: 'üò± Problem/Pain' },
            social: { keywords: ['review', 'customer', 'project', 'trust', 'rated', '500+', 'completed'], label: '‚≠ê Social Proof' },
            benefit: { keywords: ['waterproof', 'permanent', 'last', '15-20', 'anti-mold', 'warranty', 'premium'], label: '‚úÖ Benefits' },
            emotional: { keywords: ['‚ùå', 'ü§¢', 'üò±', 'üî•', 'üí™', 'love', 'beautiful', 'transform'], label: '‚ù§Ô∏è Emotional' },
            cta: { keywords: ['dm', 'whatsapp', 'call', 'book', 'free', 'quote', 'inspection'], label: 'üì± Call-to-Action' }
        };

        function analyzeStyle(text) {
            const lower = (text || '').toLowerCase();
            const scores = {};
            let total = 0;
            Object.entries(MSG_STYLES).forEach(([style, { keywords }]) => {
                const count = keywords.filter(k => lower.includes(k)).length;
                scores[style] = count;
                total += count;
            });
            // Normalize to percentages
            if (total > 0) Object.keys(scores).forEach(k => scores[k] = Math.round(scores[k] / total * 100));
            return scores;
        }

        function getContentBrainInsights() {
            const insights = [];
            if (learnings.winPatterns.length === 0) return insights;

            // Aggregate winning styles
            const winStyles = {};
            const loseStyles = {};
            learnings.winPatterns.forEach(p => {
                const ws = analyzeStyle(p.winner);
                const ls = analyzeStyle(p.loser);
                Object.entries(ws).forEach(([k, v]) => { winStyles[k] = (winStyles[k] || 0) + v; });
                Object.entries(ls).forEach(([k, v]) => { loseStyles[k] = (loseStyles[k] || 0) + v; });
            });

            // Find top winning style
            const sorted = Object.entries(winStyles).sort((a, b) => b[1] - a[1]);
            if (sorted.length > 0) {
                const topStyle = sorted[0][0];
                const label = MSG_STYLES[topStyle]?.label || topStyle;
                insights.push({
                    icon: 'üß†', title: `Your audience responds best to: ${label}`,
                    text: `From ${learnings.winPatterns.length} test(s), ${label} messaging consistently wins. Use more of this style in your posts.`,
                    action: null
                });
            }

            // Find worst style to avoid
            const loseSorted = Object.entries(loseStyles).sort((a, b) => b[1] - a[1]);
            if (loseSorted.length > 0 && sorted.length > 0 && loseSorted[0][0] !== sorted[0][0]) {
                const worstStyle = loseSorted[0][0];
                const label = MSG_STYLES[worstStyle]?.label || worstStyle;
                insights.push({
                    icon: 'üö´', title: `Avoid heavy ${label} messaging`,
                    text: `This style appeared more in losing variants. Your audience doesn't respond as well to it.`,
                    action: null
                });
            }

            // Generate new post ideas based on winning style
            const topStyle = sorted[0]?.[0];
            const postIdeas = {
                urgency: [
                    '‚è∞ "Only 8 slots left for Feb ‚Äî who needs their grout done?"',
                    'üî• "This week only: FREE tile cleaning with every booking"',
                    '‚ö° "Weekend slots filling fast ‚Äî DM to lock yours in"'
                ],
                price: [
                    'üí∞ "Bathroom grout from $439 ‚Äî cheaper than 1 year of scrubbing supplies"',
                    'üßÆ "Cost breakdown: Epoxy grout vs re-tiling your whole bathroom"',
                    'üìä "Why $439 now saves you $2,000 in 5 years"'
                ],
                problem: [
                    'ü§¢ "Your grout has 2x more bacteria than a toilet seat. Here\'s proof."',
                    'üò± "This is what lives INSIDE your cement grout (swipe ‚Üí)"',
                    'üî¨ "We scraped grout from a 5-year-old HDB bathroom. You won\'t believe what we found."'
                ],
                social: [
                    '‚≠ê "Another happy homeowner ‚Äî swipe to see the before/after"',
                    'üì∏ "Project 127 completed! Tampines 4-room HDB transformation"',
                    'üí¨ "Mrs Tan gave us 5 stars ‚Äî here\'s what she said"'
                ],
                benefit: [
                    '‚úÖ "Epoxy vs cement grout: 5 reasons professionals never go back"',
                    'üõ°Ô∏è "100% waterproof. Zero maintenance. Lasts 15-20 years."',
                    'üèÜ "The only grout that comes with a real warranty"'
                ],
                emotional: [
                    'üòç "Imagine never scrubbing grout again. That\'s what epoxy does."',
                    'üéâ "That feeling when your bathroom looks brand new again ‚Üí"',
                    'üí™ "Stop living with ugly grout. You deserve better."'
                ],
                cta: [
                    'üì± "DM GROUT for a free no-obligation quote ‚Äî takes 2 mins"',
                    '‚òéÔ∏è "WhatsApp us a photo of your grout ‚Üí we\'ll quote in 1 hour"',
                    'üÜì "Free inspection this week ‚Äî limited to 10 homes"'
                ]
            };

            if (topStyle && postIdeas[topStyle]) {
                insights.push({
                    icon: 'üí°', title: 'Post Ideas (Based on Your Winning Style)',
                    text: postIdeas[topStyle].join('\n\n'),
                    action: null
                });
            }

            // Suggest next A/B test based on learnings
            const untested = Object.keys(MSG_STYLES).filter(s => {
                return !learnings.winPatterns.some(p => {
                    const ws = analyzeStyle(p.winner);
                    return ws[s] > 30;
                });
            });
            if (untested.length >= 2) {
                const s1 = MSG_STYLES[untested[0]]?.label;
                const s2 = MSG_STYLES[untested[1]]?.label;
                insights.push({
                    icon: 'üß™', title: `Suggested Test: ${s1} vs ${s2}`,
                    text: `You haven't tested these styles yet. Create an A/B test to find out which your audience prefers.`,
                    action: 'Create This Test', actionFn: createNewTest
                });
            }

            return insights;
        }

        function getDefaultTests() {
            return [
                {
                    id: 1, name: 'FB Ad Copy: CNY vs Problem', channel: 'Facebook', status: 'running',
                    copyA: 'üßß CNY SPECIAL ‚Äî 10% OFF All Packages! Bathroom $439, Kitchen $529, Full Home $1,339. Limited slots! DM "CNY" for FREE quote ‚Üí',
                    copyB: 'Is your bathroom grout DISGUSTING? ü§¢ Black mold. Yellow stains. We fix it PERMANENTLY with epoxy grout. From $439. DM for FREE inspection ‚Üí',
                    leadsA: 0, leadsB: 0, convA: 0, convB: 0, minLeads: 20, winner: null
                },
                {
                    id: 2, name: 'CTA Style: Emoji vs Direct', channel: 'Facebook', status: 'running',
                    copyA: 'üì± DM us "CNY" to get your FREE quote today!',
                    copyB: 'WhatsApp 9800 4317 now ‚Äî only 12 slots left this month.',
                    leadsA: 0, leadsB: 0, convA: 0, convB: 0, minLeads: 20, winner: null
                }
            ];
        }

        // ============================
        // A/B TESTING ENGINE
        // ============================
        function evaluateTests() {
            tests.forEach(t => {
                if (t.status !== 'running') return;
                if (t.leadsA >= t.minLeads && t.leadsB >= t.minLeads) {
                    const rateA = t.leadsA > 0 ? t.convA / t.leadsA : 0;
                    const rateB = t.leadsB > 0 ? t.convB / t.leadsB : 0;
                    // Improved threshold (#9): require 10% diff for small samples, 5% for large
                    const threshold = (t.leadsA + t.leadsB) < 40 ? 0.10 : 0.05;
                    if (Math.abs(rateA - rateB) > threshold || (t.leadsA + t.leadsB) >= t.minLeads * 3) {
                        t.winner = rateA >= rateB ? 'A' : 'B';
                        t.status = 'completed';
                        learnings.totalDecisions++;
                        learnings.winPatterns.push({
                            channel: t.channel, winner: t.winner === 'A' ? t.copyA : t.copyB,
                            loser: t.winner === 'A' ? t.copyB : t.copyA,
                            winRate: Math.max(rateA, rateB), loseRate: Math.min(rateA, rateB),
                            date: new Date().toISOString()
                        });
                        setData('learnings', learnings);
                    }
                }
            });
            setData('tests', tests);
        }

        // ============================
        // AI INSIGHTS ENGINE
        // ============================
        function generateInsights() {
            const insights = [];
            const now = new Date();

            // Channel analysis
            const channels = {};
            leads.forEach(l => {
                if (!channels[l.channel]) channels[l.channel] = { total: 0, booked: 0, hot: 0, revenue: 0 };
                channels[l.channel].total++;
                if (l.status === 'Booked') { channels[l.channel].booked++; channels[l.channel].revenue += PRICES[l.package] || 0; }
                if (l.status === 'Hot') channels[l.channel].hot++;
            });

            // Best channel insight
            let bestCh = null, bestRate = 0;
            Object.entries(channels).forEach(([ch, d]) => {
                const rate = d.total > 0 ? (d.booked + d.hot) / d.total : 0;
                if (rate > bestRate && d.total >= 3) { bestRate = rate; bestCh = ch; }
            });
            if (bestCh) {
                insights.push({
                    icon: 'üèÜ', title: `${bestCh} is your best channel`,
                    text: `${(bestRate * 100).toFixed(0)}% of ${bestCh} leads are hot or booked. Double down here ‚Äî increase budget by 50% and test new copy variations.`,
                    action: `Create new ${bestCh} A/B test`, actionFn: () => { document.getElementById('testChannel').value = bestCh; createNewTest(); }
                });
            }

            // Worst channel insight
            let worstCh = null, worstRate = 1;
            Object.entries(channels).forEach(([ch, d]) => {
                const rate = d.total > 0 ? (d.booked + d.hot) / d.total : 0;
                if (rate < worstRate && d.total >= 3) { worstRate = rate; worstCh = ch; }
            });
            if (worstCh && worstCh !== bestCh) {
                insights.push({
                    icon: '‚ö†Ô∏è', title: `Consider pausing ${worstCh}`,
                    text: `Only ${(worstRate * 100).toFixed(0)}% conversion. Either the copy isn't resonating or you're targeting the wrong audience. Test completely different messaging before spending more.`,
                    action: null
                });
            }

            // A/B test insights
            tests.filter(t => t.status === 'completed').forEach(t => {
                const winCopy = t.winner === 'A' ? t.copyA : t.copyB;
                const winRate = t.winner === 'A' ? (t.leadsA > 0 ? t.convA / t.leadsA : 0) : (t.leadsB > 0 ? t.convB / t.leadsB : 0);
                const loseRate = t.winner === 'A' ? (t.leadsB > 0 ? t.convB / t.leadsB : 0) : (t.leadsA > 0 ? t.convA / t.leadsA : 0);
                insights.push({
                    icon: 'üß™', title: `Winner found: "${t.name}"`,
                    text: `Use this copy everywhere on ${t.channel}: "${winCopy.substring(0, 80)}..." ‚Äî it outperformed by ${Math.abs((winRate - loseRate) * 100).toFixed(0)}%.`,
                    action: 'Copy winning text', actionFn: () => { navigator.clipboard.writeText(winCopy); alert('Copied!'); }
                });
            });

            // Time-based insights
            const thisWeek = leads.filter(l => (now - new Date(l.date)) < 7 * 86400000);
            const lastWeek = leads.filter(l => { const d = now - new Date(l.date); return d >= 7 * 86400000 && d < 14 * 86400000; });
            if (thisWeek.length > 0 && lastWeek.length > 0) {
                const change = ((thisWeek.length - lastWeek.length) / lastWeek.length * 100).toFixed(0);
                insights.push({
                    icon: change >= 0 ? 'üìà' : 'üìâ', title: `Leads ${change >= 0 ? 'up' : 'down'} ${Math.abs(change)}% this week`,
                    text: `${thisWeek.length} leads this week vs ${lastWeek.length} last week. ${change >= 0 ? 'Keep doing what\'s working!' : 'Time to refresh your ad copy or increase budget.'}`,
                    action: null
                });
            }

            // Brain level
            const brainLevel = Math.min(10, 1 + Math.floor(leads.length / 5) + learnings.totalDecisions);

            // ============================
            // CONTENT BRAIN INSIGHTS (replaces old naive copy suggestion)
            // ============================
            const contentInsights = getContentBrainInsights();
            insights.push(...contentInsights);

            if (leads.length === 0) {
                insights.push(
                    { icon: 'üöÄ', title: 'Get Started', text: 'Log your first lead to start training the AI. Every lead you log makes the system smarter ‚Äî it learns which channels and copy convert best.', action: 'Log First Lead', actionFn: openModal },
                    { icon: 'üìã', title: 'Your First A/B Test is Ready', text: 'Two default tests are set up: CNY promo vs problem-agitation copy, and emoji CTA vs direct CTA. As you log leads, tag which ad brought them in.', action: null }
                );
            }

            return { insights, brainLevel };
        }

        // ============================
        // TEMPLATES
        // ============================
        function getTemplates() {
            const best = learnings.winPatterns.length > 0 ? learnings.winPatterns[learnings.winPatterns.length - 1].winner : null;
            return [
                {
                    platform: 'Facebook Marketplace', icon: 'üè™', copies: [
                        { label: 'Listing Title', text: 'üßß CNY 10% OFF | Professional Epoxy Grout | $439' },
                        { label: 'Description', text: `CLEANGROUT Professional Epoxy Grout Service\n‚úÖ Singapore island-wide & JB\n\nüöø Bathroom ‚Äî $439 (usual $780)\nüç≥ Kitchen ‚Äî $529 (usual $980)\nüè† Full Home ‚Äî $1,339 (usual $2,380)\n\n100% waterproof ‚Ä¢ Anti-mold ‚Ä¢ 15-year life ‚Ä¢ Done in 1 day\n\nüì± WhatsApp: 9800 4317` }
                    ]
                },
                {
                    platform: 'Facebook Ad', icon: 'üìò', copies: [
                        { label: best ? 'üèÜ Winning Copy' : 'Option A ‚Äî CNY Promo', text: best || 'üßß CNY SPECIAL ‚Äî 10% OFF All Packages (Ends Feb 28!)\n\nYour grout is full of mold & stains? üò±\n\nWe replace it with PREMIUM EPOXY GROUT:\n‚úÖ 100% Waterproof\n‚úÖ Anti-mold & stain-proof\n‚úÖ Lasts 15-20 years\n‚úÖ Done in 1 day\n\nüî• Bathroom $439 ¬∑ Kitchen $529 ¬∑ Full Home $1,339\n\nüì± DM "CNY" for FREE quote ‚Üí' },
                        { label: 'Option B ‚Äî Problem', text: 'Is your bathroom grout DISGUSTING? ü§¢\n\nBlack mold. Yellow stains. Crumbling gaps.\nNo amount of scrubbing will fix cement grout.\n\nThe permanent solution? EPOXY GROUT.\n‚úÖ 100% waterproof\n‚úÖ Mold literally cannot grow\n‚úÖ From just $439\n\nüì± WhatsApp us for FREE inspection ‚Üí' }
                    ]
                },
                {
                    platform: 'WhatsApp Broadcast', icon: 'üì±', copies: [
                        { label: 'CNY Blast', text: 'Hi [Name]! üßß\n\nCLEANGROUT is running a CNY Special ‚Äî 10% OFF all packages until Feb 28!\n\nüöø Bathroom ‚Äî $439\nüç≥ Kitchen ‚Äî $529\nüè† Full Home ‚Äî $1,339\n\nWant me to hold a slot for you? Reply YES and I\'ll book your free inspection! üòä' },
                        { label: 'Follow-Up', text: 'Hi [Name]! Just following up on your epoxy grout enquiry üòä\n\nOur CNY 10% OFF ends soon ‚Äî shall I book your free inspection this week?\n\nNo obligation, we just assess and quote. Takes 15 min!' }
                    ]
                }
            ];
        }

        // ============================
        // RENDER FUNCTIONS
        // ============================
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', ['dashboard', 'ab', 'leads', 'insights', 'templates'][i] === name);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            render();
        }

        function render() {
            evaluateTests();
            const { insights, brainLevel } = generateInsights();

            // Brain level
            const bl = document.getElementById('brainLevel');
            if (bl) {
                bl.textContent = brainLevel;
                bl.parentElement.innerHTML = `üß† Brain Level: <span>${brainLevel}</span>/10`;
            }

            // Stats
            const booked = leads.filter(l => l.status === 'Booked').length;
            document.getElementById('totalLeads').textContent = leads.length;
            document.getElementById('convRate').textContent = leads.length > 0 ? (booked / leads.length * 100).toFixed(0) + '%' : '0%';
            document.getElementById('revenue').textContent = '$' + leads.filter(l => l.status === 'Booked').reduce((s, l) => s + (PRICES[l.package] || 0), 0).toLocaleString();

            // Best channel
            const chMap = {};
            leads.forEach(l => {
                if (!chMap[l.channel]) chMap[l.channel] = { t: 0, b: 0 };
                chMap[l.channel].t++;
                if (l.status === 'Booked' || l.status === 'Hot') chMap[l.channel].b++;
            });
            let bestCh = '‚Äî', bestR = 0;
            Object.entries(chMap).forEach(([c, d]) => { const r = d.b / d.t; if (r > bestR) { bestR = r; bestCh = c; } });
            document.getElementById('bestChannel').textContent = bestCh;
            document.getElementById('bestChannelRate').textContent = bestCh !== '‚Äî' ? `${(bestR * 100).toFixed(0)}% hot/booked` : '‚Äî';

            // Channel breakdown
            const chDiv = document.getElementById('channelBreakdown');
            chDiv.innerHTML = Object.entries(chMap).map(([ch, d]) => `
        <div class="stat-card">
            <div class="stat-label">${ch}</div>
            <div class="stat-value" style="font-size:24px">${d.t}</div>
            <div class="stat-change ${d.b / d.t > 0.3 ? 'stat-up' : ''}">${(d.b / d.t * 100).toFixed(0)}% converting</div>
        </div>
    `).join('');

            // Recent leads
            const rl = document.getElementById('recentLeads');
            const recent = [...leads].reverse().slice(0, 5);
            rl.innerHTML = recent.length ? `<table class="lead-table"><thead><tr><th>Name</th><th>Channel</th><th>Status</th><th>Package</th></tr></thead><tbody>${recent.map(l => `<tr><td>${esc(l.name)}</td><td><span class="channel-badge ch-${l.channel.toLowerCase().replace(/\s/g, '')}">${l.channel}</span></td><td><span class="status-${l.status.toLowerCase()}">${l.status}</span></td><td>${l.package}</td></tr>`).join('')
                }</tbody></table>` : '<p style="color:#777">No leads yet. Click "+ Log Lead" to start!</p>';

            renderTests();
            renderLeads();
            renderInsights(insights);
            renderTemplates();
            updateAdCopyDropdown();
        }

        function renderTests() {
            const active = tests.filter(t => t.status === 'running');
            const completed = tests.filter(t => t.status === 'completed');

            document.getElementById('abTests').innerHTML = active.length ? active.map(t => renderTestCard(t)).join('') : '<p style="color:#777">No active tests. Create one to start optimizing!</p>';
            document.getElementById('completedTests').innerHTML = completed.length ? completed.map(t => renderTestCard(t)).join('') : '<p style="color:#777">No completed tests yet. Tests complete when both variants reach the minimum lead count.</p>';
        }

        function renderTestCard(t) {
            const totalA = t.leadsA, totalB = t.leadsB;
            const rateA = totalA > 0 ? (t.convA / totalA * 100).toFixed(0) : 0;
            const rateB = totalB > 0 ? (t.convB / totalB * 100).toFixed(0) : 0;
            const pctA = (totalA + totalB) > 0 ? totalA / (totalA + totalB) * 100 : 50;

            return `<div class="test-grid"><div class="test-card ${t.winner === 'A' ? 'winner' : t.winner === 'B' ? 'loser' : ''}">
        <span class="test-badge ${t.winner === 'A' ? 'badge-winner' : t.winner === 'B' ? 'badge-loser' : 'badge-running'}">${t.winner === 'A' ? 'üëë WINNER' : t.winner === 'B' ? 'LOSER' : 'RUNNING'}</span>
        <div class="test-variant">Variant A ‚Äî ${t.name}</div>
        <div class="test-copy">"${t.copyA.substring(0, 120)}..."</div>
        <div class="test-metrics">
            <div class="test-metric"><div class="test-metric-val">${totalA}</div><div class="test-metric-label">Leads</div></div>
            <div class="test-metric"><div class="test-metric-val">${t.convA}</div><div class="test-metric-label">Converted</div></div>
            <div class="test-metric"><div class="test-metric-val">${rateA}%</div><div class="test-metric-label">Conv Rate</div></div>
        </div>
        <div class="progress-bar"><div class="progress-fill fill-a" style="width:${pctA}%"></div></div>
    </div><div class="test-card ${t.winner === 'B' ? 'winner' : t.winner === 'A' ? 'loser' : ''}">
        <span class="test-badge ${t.winner === 'B' ? 'badge-winner' : t.winner === 'A' ? 'badge-loser' : 'badge-running'}">${t.winner === 'B' ? 'üëë WINNER' : t.winner === 'A' ? 'LOSER' : 'RUNNING'}</span>
        <div class="test-variant">Variant B ‚Äî ${t.name}</div>
        <div class="test-copy">"${t.copyB.substring(0, 120)}..."</div>
        <div class="test-metrics">
            <div class="test-metric"><div class="test-metric-val">${totalB}</div><div class="test-metric-label">Leads</div></div>
            <div class="test-metric"><div class="test-metric-val">${t.convB}</div><div class="test-metric-label">Converted</div></div>
            <div class="test-metric"><div class="test-metric-val">${rateB}%</div><div class="test-metric-label">Conv Rate</div></div>
        </div>
        <div class="progress-bar"><div class="progress-fill fill-b" style="width:${100 - pctA}%"></div></div>
    </div></div>`;
        }

        function renderLeads() {
            const filter = document.getElementById('filterChannel').value;
            const filtered = filter === 'all' ? leads : leads.filter(l => l.channel === filter);
            const tbody = document.getElementById('leadTableBody');
            tbody.innerHTML = [...filtered].reverse().map((l, i) => {
                const idx = leads.indexOf(l);
                return `<tr>
        <td style="font-size:13px;color:#999">${new Date(l.date).toLocaleDateString()}</td>
        <td>${esc(l.name)}</td>
        <td><span class="channel-badge ch-${l.channel.toLowerCase().replace(/\s/g, '')}">${l.channel}</span></td>
        <td style="font-size:12px;color:#777;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(l.adCopy || '‚Äî')}</td>
        <td><span class="status-${l.status.toLowerCase()}">${l.status}</span></td>
        <td>${PRICES[l.package] ? '$' + PRICES[l.package] : '‚Äî'}</td>
        <td style="display:flex;gap:4px;align-items:center"><select onchange="updateLeadStatus(${idx},this.value)" style="padding:4px 8px;background:#1a1a1a;border:1px solid #333;border-radius:4px;color:#fff;font-size:12px">
            <option ${l.status === 'Hot' ? 'selected' : ''} value="Hot">üî• Hot</option>
            <option ${l.status === 'Warm' ? 'selected' : ''} value="Warm">üü° Warm</option>
            <option ${l.status === 'Cold' ? 'selected' : ''} value="Cold">‚ö™ Cold</option>
            <option ${l.status === 'Booked' ? 'selected' : ''} value="Booked">‚úÖ Booked</option>
        </select><button onclick="deleteLead(${idx})" style="background:none;border:none;color:#555;cursor:pointer;font-size:14px" title="Delete">üóë</button></td>
    </tr>`}).join('');
        }

        // Store action functions for insight buttons
        window._insightActions = {};
        function renderInsights(insights) {
            insights.forEach((ins, idx) => { if (ins.actionFn) window._insightActions[idx] = ins.actionFn; });
            document.getElementById('insightsPanel').innerHTML = insights.map((i, idx) => `
        <div class="insight-card">
            <h4>${i.icon} ${i.title}</h4>
            <p>${i.text}</p>
            ${i.action ? `<button class="action" onclick="window._insightActions[${idx}]()">${i.action}</button>` : ''}
        </div>
    `).join('');
        }

        // Store template texts for safe copy
        window._templateTexts = [];
        function renderTemplates() {
            const templates = getTemplates();
            window._templateTexts = [];
            let idx = 0;
            document.getElementById('templatesPanel').innerHTML = templates.map(t => `
        <div style="margin-bottom:24px">
            <h4 style="margin-bottom:12px">${t.icon} ${t.platform}</h4>
            ${t.copies.map(c => {
                const i = idx++;
                window._templateTexts[i] = c.text;
                return `
                <div class="test-card" style="margin-bottom:12px">
                    <div class="test-variant">${c.label}</div>
                    <pre style="font-family:'Inter',sans-serif;font-size:13px;color:#ccc;white-space:pre-wrap;line-height:1.6;margin:8px 0">${c.text}</pre>
                    <button class="btn btn-outline" style="font-size:11px;padding:6px 12px" onclick="copyTemplate(${i},this)">üìã Copy</button>
                </div>
            `}).join('')}
        </div>
    `).join('');
        }
        function copyTemplate(idx, btn) {
            navigator.clipboard.writeText(window._templateTexts[idx]).then(() => { btn.textContent = '‚úÖ Copied!'; setTimeout(() => btn.textContent = 'üìã Copy', 2000); });
        }

        function updateAdCopyDropdown() {
            const sel = document.getElementById('leadAdCopy');
            const activeTests = tests.filter(t => t.status === 'running');
            sel.innerHTML = '<option value="">‚Äî Not from a test ‚Äî</option>' +
                activeTests.map(t => `
            <option value="${t.id}_A">${t.name} ‚Äî Variant A</option>
            <option value="${t.id}_B">${t.name} ‚Äî Variant B</option>
        `).join('');
        }

        // ============================
        // ACTIONS
        // ============================
        function openModal() { document.getElementById('leadModal').classList.add('open'); }
        function closeModal() { document.getElementById('leadModal').classList.remove('open'); }
        function createNewTest() { document.getElementById('abModal').classList.add('open'); }
        function closeABModal() { document.getElementById('abModal').classList.remove('open'); }

        function saveLead() {
            const lead = {
                name: document.getElementById('leadName').value || 'Unknown',
                phone: document.getElementById('leadPhone').value,
                channel: document.getElementById('leadChannel').value,
                adCopy: document.getElementById('leadAdCopy').value,
                package: document.getElementById('leadPackage').value,
                status: document.getElementById('leadStatus').value,
                notes: document.getElementById('leadNotes').value,
                date: new Date().toISOString()
            };
            leads.push(lead);
            setData('leads', leads);

            // Update A/B test counts
            if (lead.adCopy) {
                const [testId, variant] = lead.adCopy.split('_');
                const test = tests.find(t => t.id == testId);
                if (test) {
                    if (variant === 'A') { test.leadsA++; if (lead.status === 'Booked' || lead.status === 'Hot') test.convA++; }
                    if (variant === 'B') { test.leadsB++; if (lead.status === 'Booked' || lead.status === 'Hot') test.convB++; }
                    setData('tests', tests);
                }
            }

            closeModal();
            document.getElementById('leadName').value = '';
            document.getElementById('leadPhone').value = '';
            document.getElementById('leadNotes').value = '';
            render();
        }

        function updateLeadStatus(idx, status) {
            const oldStatus = leads[idx].status;
            leads[idx].status = status;
            setData('leads', leads);

            // Update A/B test conversion if changing to/from Booked/Hot
            if (leads[idx].adCopy) {
                const [testId, variant] = leads[idx].adCopy.split('_');
                const test = tests.find(t => t.id == testId);
                if (test) {
                    const wasConv = oldStatus === 'Booked' || oldStatus === 'Hot';
                    const isConv = status === 'Booked' || status === 'Hot';
                    if (!wasConv && isConv) { if (variant === 'A') test.convA++; else test.convB++; }
                    if (wasConv && !isConv) { if (variant === 'A') test.convA = Math.max(0, test.convA - 1); else test.convB = Math.max(0, test.convB - 1); }
                    setData('tests', tests);
                }
            }
            render();
        }

        function saveTest() {
            const test = {
                id: Date.now(),
                name: document.getElementById('testName').value || 'Untitled Test',
                channel: document.getElementById('testChannel').value,
                status: 'running',
                copyA: document.getElementById('testCopyA').value,
                copyB: document.getElementById('testCopyB').value,
                leadsA: 0, leadsB: 0, convA: 0, convB: 0,
                minLeads: parseInt(document.getElementById('testMinLeads').value),
                winner: null
            };
            tests.push(test);
            setData('tests', tests);
            closeABModal();
            switchTab('ab');
        }

        function exportData() {
            const csvEsc = s => `"${String(s || '').replace(/"/g, '""')}"`;
            const csv = 'Date,Name,Phone,Channel,Ad Copy,Package,Status,Notes\n' +
                leads.map(l => [l.date, csvEsc(l.name), csvEsc(l.phone), l.channel, csvEsc(l.adCopy), l.package, l.status, csvEsc(l.notes)].join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'cleangrout_leads_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function deleteLead(idx) {
            if (!confirm('Delete this lead?')) return;
            leads.splice(idx, 1);
            setData('leads', leads);
            render();
        }

        // HTML escape to prevent XSS
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        // Close modals on backdrop click or Escape
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
        });
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
        });

        // Auto-import chatbot leads
        function importChatbotLeads() {
            const chatLeads = JSON.parse(localStorage.getItem('cleangrout_leads') || '[]');
            chatLeads.forEach(cl => {
                if (!leads.find(l => l.phone === cl.phone && l.name === cl.name)) {
                    leads.push({
                        name: cl.name, phone: cl.phone, channel: 'Website',
                        adCopy: '', package: cl.package || 'Unsure', status: 'Warm',
                        notes: 'Auto-imported from chatbot', date: cl.timestamp
                    });
                }
            });
            setData('leads', leads);
        }

        // Init
        importChatbotLeads();
        render();
    </script>
</body>

</html>