<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadGen AI â€” CLEANGROUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0A0A0A;
            color: #fff;
            min-height: 100vh
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #222;
            margin-bottom: 30px
        }

        .header h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.02em
        }

        .header h1 span {
            color: #D32F2F
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .brain-score {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px
        }

        .brain-score span {
            color: #FFD700;
            font-weight: 800
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s
        }

        .btn-primary {
            background: #D32F2F;
            color: #fff
        }

        .btn-primary:hover {
            background: #B71C1C
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid #444;
            color: #fff
        }

        .btn-outline:hover {
            border-color: #fff
        }

        .btn-gold {
            background: #FFD700;
            color: #0A0A0A
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #111;
            padding: 4px;
            border-radius: 10px;
            width: fit-content
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            border: none;
            background: transparent;
            color: #777
        }

        .tab.active {
            background: #fff;
            color: #0A0A0A
        }

        .tab:hover:not(.active) {
            color: #fff
        }

        .tab-content {
            display: none
        }

        .tab-content.active {
            display: block
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px
        }

        .stat-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px
        }

        .stat-label {
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: 6px
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.02em
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px
        }

        .stat-up {
            color: #4CAF50
        }

        .stat-down {
            color: #D32F2F
        }

        /* A/B Test Cards */
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px
        }

        .test-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px;
            position: relative
        }

        .test-card.winner {
            border-color: #FFD700
        }

        .test-card.loser {
            opacity: .6
        }

        .test-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700
        }

        .badge-winner {
            background: #FFD700;
            color: #0A0A0A
        }

        .badge-running {
            background: #333;
            color: #fff
        }

        .badge-loser {
            background: #D32F2F;
            color: #fff
        }

        .test-variant {
            font-size: 11px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 8px
        }

        .test-copy {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
            color: #ccc
        }

        .test-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px
        }

        .test-metric {
            text-align: center
        }

        .test-metric-val {
            font-size: 20px;
            font-weight: 800
        }

        .test-metric-label {
            font-size: 11px;
            color: #777
        }

        .progress-bar {
            height: 6px;
            background: #222;
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .5s
        }

        .fill-a {
            background: #D32F2F
        }

        .fill-b {
            background: #4CAF50
        }

        /* Lead Log */
        .lead-table {
            width: 100%;
            border-collapse: collapse
        }

        .lead-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: .05em;
            border-bottom: 1px solid #222
        }

        .lead-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid #1a1a1a
        }

        .lead-table tr:hover {
            background: #111
        }

        .channel-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700
        }

        .ch-fb {
            background: rgba(66, 103, 178, .2);
            color: #4267B2
        }

        .ch-ig {
            background: rgba(225, 48, 108, .2);
            color: #E1306C
        }

        .ch-goog {
            background: rgba(66, 133, 244, .2);
            color: #4285F4
        }

        .ch-wa {
            background: rgba(37, 211, 102, .2);
            color: #25D366
        }

        .ch-web {
            background: rgba(255, 215, 0, .2);
            color: #FFD700
        }

        .ch-mktp {
            background: rgba(255, 255, 255, .1);
            color: #fff
        }

        .status-hot {
            color: #D32F2F;
            font-weight: 700
        }

        .status-warm {
            color: #FF9800;
            font-weight: 700
        }

        .status-cold {
            color: #777
        }

        .status-booked {
            color: #4CAF50;
            font-weight: 700
        }

        /* Insights Panel */
        .insight-card {
            background: linear-gradient(135deg, #111, #1a1a1a);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px
        }

        .insight-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .insight-card p {
            font-size: 13px;
            color: #999;
            line-height: 1.6
        }

        .insight-card .action {
            margin-top: 12px;
            padding: 8px 16px;
            background: #D32F2F;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif
        }

        /* Add Lead Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.open {
            display: flex
        }

        .modal {
            background: #111;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 30px;
            width: 480px;
            max-width: 90vw
        }

        .modal h3 {
            margin-bottom: 20px;
            font-size: 18px
        }

        .form-group {
            margin-bottom: 16px
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #777;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: .05em
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: #0a0a0a;
            border: 1.5px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-family: 'Inter', sans-serif
        }

        .form-group textarea {
            height: 80px;
            resize: vertical
        }

        .form-group select option {
            background: #111
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px
        }

        /* Responsive */
        @media(max-width:768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr)
            }

            .test-grid {
                grid-template-columns: 1fr
            }

            .header {
                flex-direction: column;
                gap: 12px
            }
        }
    </style>
</head>

<body>
    <!-- PIN Lock Screen -->
    <div id="pinLock"
        style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0A0A0A;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px">
        <h2 style="font-family:'Inter',sans-serif;font-weight:800;font-size:24px;color:#fff">LeadGen <span
                style="color:#D32F2F">AI</span></h2>
        <p style="font-family:'Inter',sans-serif;color:#777;font-size:14px">Enter PIN to access</p>
        <input type="password" id="pinInput" maxlength="6" placeholder="â€¢â€¢â€¢â€¢"
            style="width:200px;text-align:center;padding:14px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;font-size:24px;font-family:'Inter',sans-serif;letter-spacing:0.3em"
            onkeydown="if(event.key==='Enter')checkPin()">
        <button onclick="checkPin()"
            style="padding:12px 32px;background:#D32F2F;color:#fff;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-weight:700;font-size:14px;cursor:pointer">Unlock</button>
        <p id="pinError" style="font-family:'Inter',sans-serif;color:#D32F2F;font-size:13px;display:none">Wrong PIN</p>
    </div>

    <!-- Backup Reminder Banner -->
    <div id="backupBanner"
        style="display:none;background:#FF9800;color:#0A0A0A;padding:10px 20px;text-align:center;font-family:'Inter',sans-serif;font-size:13px;font-weight:600">
        âš ï¸ You have <span id="backupCount"></span> leads stored in this browser only. <button
            onclick="exportData();this.parentElement.style.display='none'"
            style="background:#0A0A0A;color:#fff;border:none;padding:6px 14px;border-radius:4px;font-weight:700;cursor:pointer;font-size:12px;margin-left:8px">Export
            CSV Backup</button>
        <button onclick="this.parentElement.style.display='none';localStorage.setItem('lg_lastBackup',Date.now())"
            style="background:none;border:none;color:#0A0A0A;cursor:pointer;font-size:16px;margin-left:4px">&times;</button>
    </div>

    <div class="app">
        <div class="header">
            <h1>LeadGen <span>AI</span></h1>
            <div class="header-right">
                <div class="brain-score">ğŸ§  Brain Level: <span id="brainLevel">1</span></div>
                <button class="btn btn-outline" onclick="changePin()" style="font-size:11px;padding:8px 12px">ğŸ”’
                    PIN</button>
                <button class="btn btn-outline" onclick="exportData()">Export CSV</button>
                <button class="btn btn-primary" onclick="openModal()">+ Log Lead</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('ab')">A/B Tests</div>
            <div class="tab" onclick="switchTab('leads')">Lead Log</div>
            <div class="tab" onclick="switchTab('insights')">AI Insights</div>
            <div class="tab" onclick="switchTab('content')">ğŸ¬ Content Studio</div>
            <div class="tab" onclick="switchTab('analytics')">ğŸ“Š Analytics</div>
            <div class="tab" onclick="switchTab('templates')">Ad Templates</div>
        </div>

        <!-- DASHBOARD -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="totalLeads">0</div>
                    <div class="stat-change stat-up" id="leadsChange">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-value" id="convRate">0%</div>
                    <div class="stat-change" id="convChange">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Channel</div>
                    <div class="stat-value" id="bestChannel" style="font-size:22px">â€”</div>
                    <div class="stat-change stat-up" id="bestChannelRate">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Revenue (Est.)</div>
                    <div class="stat-value" id="revenue">$0</div>
                    <div class="stat-change stat-up" id="revChange">â€”</div>
                </div>
            </div>
            <h3 style="margin-bottom:16px">ğŸ“Š Channel Performance</h3>
            <div id="channelBreakdown"
                style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:30px"></div>
            <h3 style="margin-bottom:16px">âš¡ Recent Leads</h3>
            <div id="recentLeads"></div>
            <h3 style="margin:24px 0 16px">ğŸ”” Follow-Up Reminders</h3>
            <div id="followUpPanel"></div>
        </div>

        <!-- A/B TESTS -->
        <div class="tab-content" id="tab-ab">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3>ğŸ§ª Active A/B Tests</h3>
                <button class="btn btn-primary" onclick="createNewTest()">+ New Test</button>
            </div>
            <div id="abTests"></div>
            <h3 style="margin:30px 0 16px">ğŸ† Completed Tests</h3>
            <div id="completedTests"></div>
        </div>

        <!-- LEADS -->
        <div class="tab-content" id="tab-leads">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3>ğŸ“‹ All Leads</h3>
                <div style="display:flex;gap:8px">
                    <select id="filterChannel" onchange="renderLeads()"
                        style="padding:8px 12px;background:#111;border:1px solid #333;border-radius:6px;color:#fff;font-size:13px">
                        <option value="all">All Channels</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Google">Google</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Website">Website</option>
                        <option value="Marketplace">Marketplace</option>
                        <option value="TikTok">TikTok/Reels</option>
                    </select>
                </div>
            </div>
            <table class="lead-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Channel</th>
                        <th>Ad Copy</th>
                        <th>Status</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadTableBody"></tbody>
            </table>
        </div>

        <!-- AI INSIGHTS -->
        <div class="tab-content" id="tab-insights">
            <h3 style="margin-bottom:20px">ğŸ§  AI Analysis & Recommendations</h3>
            <div id="insightsPanel"></div>
        </div>

        <!-- CONTENT STUDIO -->
        <div class="tab-content" id="tab-content">
            <h3 style="margin-bottom:20px">ğŸ¬ Content Studio â€” ASMR, Reels & Content Calendar</h3>
            <div id="contentStudioPanel"></div>
        </div>

        <!-- ANALYTICS -->
        <div class="tab-content" id="tab-analytics">
            <h3 style="margin-bottom:20px">ğŸ“Š Analytics â€” SEO, AEO & Tracking</h3>
            <div id="analyticsPanel"></div>
        </div>

        <!-- AD TEMPLATES -->
        <div class="tab-content" id="tab-templates">
            <h3 style="margin-bottom:20px">ğŸ“ Ready-to-Use Templates</h3>
            <div id="templatesPanel"></div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal">
            <h3>Log New Lead</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="leadName" placeholder="Customer name">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="leadPhone" placeholder="+65 9XXX XXXX">
            </div>
            <div class="form-group">
                <label>Channel</label>
                <select id="leadChannel">
                    <option value="Facebook">Facebook</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Google">Google</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Website">Website (Chatbot)</option>
                    <option value="Marketplace">FB Marketplace</option>
                    <option value="TikTok">TikTok/Reels/Shorts</option>
                </select>
            </div>
            <div class="form-group">
                <label>Which Ad Copy Brought Them?</label>
                <select id="leadAdCopy"></select>
            </div>
            <div class="form-group">
                <label>Package Interest</label>
                <select id="leadPackage">
                    <option value="Bathroom">Bathroom ($439)</option>
                    <option value="Kitchen">Kitchen ($529)</option>
                    <option value="Full Home">Full Home ($1,339)</option>
                    <option value="Unsure">Not sure yet</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="leadStatus">
                    <option value="Hot">ğŸ”¥ Hot â€” Ready to book</option>
                    <option value="Warm">ğŸŸ¡ Warm â€” Interested</option>
                    <option value="Cold">âšª Cold â€” Just enquiring</option>
                    <option value="Booked">âœ… Booked!</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="leadNotes" placeholder="Any details..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLead()">Save Lead</button>
            </div>
        </div>
    </div>

    <!-- New A/B Test Modal -->
    <div class="modal-overlay" id="abModal">
        <div class="modal">
            <h3>ğŸ§ª Create A/B Test</h3>
            <div class="form-group">
                <label>Test Name</label>
                <input type="text" id="testName" placeholder="e.g. FB Ad Copy - CNY vs Problem">
            </div>
            <div class="form-group">
                <label>Channel</label>
                <select id="testChannel">
                    <option value="Facebook">Facebook</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Google">Google</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Marketplace">FB Marketplace</option>
                </select>
            </div>
            <div class="form-group">
                <label>Variant A â€” Copy</label>
                <textarea id="testCopyA" placeholder="First ad copy variation..."></textarea>
            </div>
            <div class="form-group">
                <label>Variant B â€” Copy</label>
                <textarea id="testCopyB" placeholder="Second ad copy variation..."></textarea>
            </div>
            <div class="form-group">
                <label>Min Leads to Declare Winner</label>
                <select id="testMinLeads">
                    <option value="10">10 leads each</option>
                    <option value="20" selected>20 leads each</option>
                    <option value="30">30 leads each</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeABModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTest()">Start Test</button>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // PIN LOCK (#8)
        // ============================
        const DEFAULT_PIN = '1234';
        function checkPin() {
            const pin = document.getElementById('pinInput').value;
            const storedPin = localStorage.getItem('lg_pin') || DEFAULT_PIN;
            if (pin === storedPin) {
                document.getElementById('pinLock').style.display = 'none';
                showBackupReminder();
            } else {
                document.getElementById('pinError').style.display = 'block';
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').style.borderColor = '#D32F2F';
                setTimeout(() => { document.getElementById('pinInput').style.borderColor = '#333'; document.getElementById('pinError').style.display = 'none'; }, 1500);
            }
        }
        function changePin() {
            const newPin = prompt('Enter new PIN (4-6 digits):');
            if (newPin && /^\d{4,6}$/.test(newPin)) {
                localStorage.setItem('lg_pin', newPin);
                alert('PIN updated!');
            } else if (newPin) { alert('PIN must be 4-6 digits'); }
        }

        // ============================
        // BACKUP REMINDER (#7)
        // ============================
        function showBackupReminder() {
            const leads = getData('leads', []);
            const lastBackup = parseInt(localStorage.getItem('lg_lastBackup') || '0');
            const daysSinceBackup = (Date.now() - lastBackup) / 86400000;
            if (leads.length >= 10 && daysSinceBackup > 3) {
                document.getElementById('backupBanner').style.display = 'block';
                document.getElementById('backupCount').textContent = leads.length;
            }
        }

        // ============================
        // LEADGEN AI â€” SELF-LEARNING ENGINE
        // ============================

        const PRICES = { Bathroom: 439, Kitchen: 529, 'Full Home': 1339, Unsure: 0 };

        // Data Store
        function getData(key, def) { return JSON.parse(localStorage.getItem('lg_' + key) || JSON.stringify(def)); }
        function setData(key, val) { localStorage.setItem('lg_' + key, JSON.stringify(val)); }

        let leads = getData('leads', []);
        let tests = getData('tests', getDefaultTests());
        let learnings = getData('learnings', { totalDecisions: 0, winPatterns: [] });

        // ============================
        // CONTENT BRAIN â€” LEARNS WHAT TO POST
        // ============================
        const MSG_STYLES = {
            urgency: { keywords: ['limited', 'slots', 'left', 'ends', 'hurry', 'only', 'last'], label: 'â° Urgency/Scarcity' },
            price: { keywords: ['$', 'off', 'discount', 'save', 'deal', 'special', 'promo', 'cheap'], label: 'ğŸ’° Price/Discount' },
            problem: { keywords: ['mold', 'stain', 'disgusting', 'dirty', 'ugly', 'crack', 'bacteria', 'scrub'], label: 'ğŸ˜± Problem/Pain' },
            social: { keywords: ['review', 'customer', 'project', 'trust', 'rated', '500+', 'completed'], label: 'â­ Social Proof' },
            benefit: { keywords: ['waterproof', 'permanent', 'last', '15-20', 'anti-mold', 'warranty', 'premium'], label: 'âœ… Benefits' },
            emotional: { keywords: ['âŒ', 'ğŸ¤¢', 'ğŸ˜±', 'ğŸ”¥', 'ğŸ’ª', 'love', 'beautiful', 'transform'], label: 'â¤ï¸ Emotional' },
            cta: { keywords: ['dm', 'whatsapp', 'call', 'book', 'free', 'quote', 'inspection'], label: 'ğŸ“± Call-to-Action' }
        };

        function analyzeStyle(text) {
            const lower = (text || '').toLowerCase();
            const scores = {};
            let total = 0;
            Object.entries(MSG_STYLES).forEach(([style, { keywords }]) => {
                const count = keywords.filter(k => lower.includes(k)).length;
                scores[style] = count;
                total += count;
            });
            // Normalize to percentages
            if (total > 0) Object.keys(scores).forEach(k => scores[k] = Math.round(scores[k] / total * 100));
            return scores;
        }

        function getContentBrainInsights() {
            const insights = [];
            if (learnings.winPatterns.length === 0) return insights;

            // Aggregate winning styles
            const winStyles = {};
            const loseStyles = {};
            learnings.winPatterns.forEach(p => {
                const ws = analyzeStyle(p.winner);
                const ls = analyzeStyle(p.loser);
                Object.entries(ws).forEach(([k, v]) => { winStyles[k] = (winStyles[k] || 0) + v; });
                Object.entries(ls).forEach(([k, v]) => { loseStyles[k] = (loseStyles[k] || 0) + v; });
            });

            // Find top winning style
            const sorted = Object.entries(winStyles).sort((a, b) => b[1] - a[1]);
            if (sorted.length > 0) {
                const topStyle = sorted[0][0];
                const label = MSG_STYLES[topStyle]?.label || topStyle;
                insights.push({
                    icon: 'ğŸ§ ', title: `Your audience responds best to: ${label}`,
                    text: `From ${learnings.winPatterns.length} test(s), ${label} messaging consistently wins. Use more of this style in your posts.`,
                    action: null
                });
            }

            // Find worst style to avoid
            const loseSorted = Object.entries(loseStyles).sort((a, b) => b[1] - a[1]);
            if (loseSorted.length > 0 && sorted.length > 0 && loseSorted[0][0] !== sorted[0][0]) {
                const worstStyle = loseSorted[0][0];
                const label = MSG_STYLES[worstStyle]?.label || worstStyle;
                insights.push({
                    icon: 'ğŸš«', title: `Avoid heavy ${label} messaging`,
                    text: `This style appeared more in losing variants. Your audience doesn't respond as well to it.`,
                    action: null
                });
            }

            // Generate new post ideas based on winning style
            const topStyle = sorted[0]?.[0];
            const postIdeas = {
                urgency: [
                    'â° "Only 8 slots left for Feb â€” who needs their grout done?"',
                    'ğŸ”¥ "This week only: FREE tile cleaning with every booking"',
                    'âš¡ "Weekend slots filling fast â€” DM to lock yours in"'
                ],
                price: [
                    'ğŸ’° "Bathroom grout from $439 â€” cheaper than 1 year of scrubbing supplies"',
                    'ğŸ§® "Cost breakdown: Epoxy grout vs re-tiling your whole bathroom"',
                    'ğŸ“Š "Why $439 now saves you $2,000 in 5 years"'
                ],
                problem: [
                    'ğŸ¤¢ "Your grout has 2x more bacteria than a toilet seat. Here\'s proof."',
                    'ğŸ˜± "This is what lives INSIDE your cement grout (swipe â†’)"',
                    'ğŸ”¬ "We scraped grout from a 5-year-old HDB bathroom. You won\'t believe what we found."'
                ],
                social: [
                    'â­ "Another happy homeowner â€” swipe to see the before/after"',
                    'ğŸ“¸ "Project 127 completed! Tampines 4-room HDB transformation"',
                    'ğŸ’¬ "Mrs Tan gave us 5 stars â€” here\'s what she said"'
                ],
                benefit: [
                    'âœ… "Epoxy vs cement grout: 5 reasons professionals never go back"',
                    'ğŸ›¡ï¸ "100% waterproof. Zero maintenance. Lasts 15-20 years."',
                    'ğŸ† "The only grout that comes with a real warranty"'
                ],
                emotional: [
                    'ğŸ˜ "Imagine never scrubbing grout again. That\'s what epoxy does."',
                    'ğŸ‰ "That feeling when your bathroom looks brand new again â†’"',
                    'ğŸ’ª "Stop living with ugly grout. You deserve better."'
                ],
                cta: [
                    'ğŸ“± "DM GROUT for a free no-obligation quote â€” takes 2 mins"',
                    'â˜ï¸ "WhatsApp us a photo of your grout â†’ we\'ll quote in 1 hour"',
                    'ğŸ†“ "Free inspection this week â€” limited to 10 homes"'
                ]
            };

            if (topStyle && postIdeas[topStyle]) {
                insights.push({
                    icon: 'ğŸ’¡', title: 'Post Ideas (Based on Your Winning Style)',
                    text: postIdeas[topStyle].join('\n\n'),
                    action: null
                });
            }

            // Suggest next A/B test based on learnings
            const untested = Object.keys(MSG_STYLES).filter(s => {
                return !learnings.winPatterns.some(p => {
                    const ws = analyzeStyle(p.winner);
                    return ws[s] > 30;
                });
            });
            if (untested.length >= 2) {
                const s1 = MSG_STYLES[untested[0]]?.label;
                const s2 = MSG_STYLES[untested[1]]?.label;
                insights.push({
                    icon: 'ğŸ§ª', title: `Suggested Test: ${s1} vs ${s2}`,
                    text: `You haven't tested these styles yet. Create an A/B test to find out which your audience prefers.`,
                    action: 'Create This Test', actionFn: createNewTest
                });
            }

            return insights;
        }

        function getDefaultTests() {
            return [
                {
                    id: 1, name: 'FB Ad Copy: CNY vs Problem', channel: 'Facebook', status: 'running',
                    copyA: 'ğŸ§§ CNY SPECIAL â€” 10% OFF All Packages! Bathroom $439, Kitchen $529, Full Home $1,339. Limited slots! DM "CNY" for FREE quote â†’',
                    copyB: 'Is your bathroom grout DISGUSTING? ğŸ¤¢ Black mold. Yellow stains. We fix it PERMANENTLY with epoxy grout. From $439. DM for FREE inspection â†’',
                    leadsA: 0, leadsB: 0, convA: 0, convB: 0, minLeads: 20, winner: null
                },
                {
                    id: 2, name: 'CTA Style: Emoji vs Direct', channel: 'Facebook', status: 'running',
                    copyA: 'ğŸ“± DM us "CNY" to get your FREE quote today!',
                    copyB: 'WhatsApp 9800 4317 now â€” only 12 slots left this month.',
                    leadsA: 0, leadsB: 0, convA: 0, convB: 0, minLeads: 20, winner: null
                }
            ];
        }

        // ============================
        // A/B TESTING ENGINE
        // ============================
        function evaluateTests() {
            tests.forEach(t => {
                if (t.status !== 'running') return;
                if (t.leadsA >= t.minLeads && t.leadsB >= t.minLeads) {
                    const rateA = t.leadsA > 0 ? t.convA / t.leadsA : 0;
                    const rateB = t.leadsB > 0 ? t.convB / t.leadsB : 0;
                    // Improved threshold (#9): require 10% diff for small samples, 5% for large
                    const threshold = (t.leadsA + t.leadsB) < 40 ? 0.10 : 0.05;
                    if (Math.abs(rateA - rateB) > threshold || (t.leadsA + t.leadsB) >= t.minLeads * 3) {
                        t.winner = rateA >= rateB ? 'A' : 'B';
                        t.status = 'completed';
                        learnings.totalDecisions++;
                        learnings.winPatterns.push({
                            channel: t.channel, winner: t.winner === 'A' ? t.copyA : t.copyB,
                            loser: t.winner === 'A' ? t.copyB : t.copyA,
                            winRate: Math.max(rateA, rateB), loseRate: Math.min(rateA, rateB),
                            date: new Date().toISOString()
                        });
                        setData('learnings', learnings);
                    }
                }
            });
            setData('tests', tests);
        }

        // ============================
        // AI INSIGHTS ENGINE
        // ============================
        function generateInsights() {
            const insights = [];
            const now = new Date();

            // Channel analysis
            const channels = {};
            leads.forEach(l => {
                if (!channels[l.channel]) channels[l.channel] = { total: 0, booked: 0, hot: 0, revenue: 0 };
                channels[l.channel].total++;
                if (l.status === 'Booked') { channels[l.channel].booked++; channels[l.channel].revenue += PRICES[l.package] || 0; }
                if (l.status === 'Hot') channels[l.channel].hot++;
            });

            // Best channel insight
            let bestCh = null, bestRate = 0;
            Object.entries(channels).forEach(([ch, d]) => {
                const rate = d.total > 0 ? (d.booked + d.hot) / d.total : 0;
                if (rate > bestRate && d.total >= 3) { bestRate = rate; bestCh = ch; }
            });
            if (bestCh) {
                insights.push({
                    icon: 'ğŸ†', title: `${bestCh} is your best channel`,
                    text: `${(bestRate * 100).toFixed(0)}% of ${bestCh} leads are hot or booked. Double down here â€” increase budget by 50% and test new copy variations.`,
                    action: `Create new ${bestCh} A/B test`, actionFn: () => { document.getElementById('testChannel').value = bestCh; createNewTest(); }
                });
            }

            // Worst channel insight
            let worstCh = null, worstRate = 1;
            Object.entries(channels).forEach(([ch, d]) => {
                const rate = d.total > 0 ? (d.booked + d.hot) / d.total : 0;
                if (rate < worstRate && d.total >= 3) { worstRate = rate; worstCh = ch; }
            });
            if (worstCh && worstCh !== bestCh) {
                insights.push({
                    icon: 'âš ï¸', title: `Consider pausing ${worstCh}`,
                    text: `Only ${(worstRate * 100).toFixed(0)}% conversion. Either the copy isn't resonating or you're targeting the wrong audience. Test completely different messaging before spending more.`,
                    action: null
                });
            }

            // A/B test insights
            tests.filter(t => t.status === 'completed').forEach(t => {
                const winCopy = t.winner === 'A' ? t.copyA : t.copyB;
                const winRate = t.winner === 'A' ? (t.leadsA > 0 ? t.convA / t.leadsA : 0) : (t.leadsB > 0 ? t.convB / t.leadsB : 0);
                const loseRate = t.winner === 'A' ? (t.leadsB > 0 ? t.convB / t.leadsB : 0) : (t.leadsA > 0 ? t.convA / t.leadsA : 0);
                insights.push({
                    icon: 'ğŸ§ª', title: `Winner found: "${t.name}"`,
                    text: `Use this copy everywhere on ${t.channel}: "${winCopy.substring(0, 80)}..." â€” it outperformed by ${Math.abs((winRate - loseRate) * 100).toFixed(0)}%.`,
                    action: 'Copy winning text', actionFn: () => { navigator.clipboard.writeText(winCopy); alert('Copied!'); }
                });
            });

            // Time-based insights
            const thisWeek = leads.filter(l => (now - new Date(l.date)) < 7 * 86400000);
            const lastWeek = leads.filter(l => { const d = now - new Date(l.date); return d >= 7 * 86400000 && d < 14 * 86400000; });
            if (thisWeek.length > 0 && lastWeek.length > 0) {
                const change = ((thisWeek.length - lastWeek.length) / lastWeek.length * 100).toFixed(0);
                insights.push({
                    icon: change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰', title: `Leads ${change >= 0 ? 'up' : 'down'} ${Math.abs(change)}% this week`,
                    text: `${thisWeek.length} leads this week vs ${lastWeek.length} last week. ${change >= 0 ? 'Keep doing what\'s working!' : 'Time to refresh your ad copy or increase budget.'}`,
                    action: null
                });
            }

            // Brain level
            const brainLevel = Math.min(10, 1 + Math.floor(leads.length / 5) + learnings.totalDecisions);

            // ============================
            // CONTENT BRAIN INSIGHTS (replaces old naive copy suggestion)
            // ============================
            const contentInsights = getContentBrainInsights();
            insights.push(...contentInsights);

            if (leads.length === 0) {
                insights.push(
                    { icon: 'ğŸš€', title: 'Get Started', text: 'Log your first lead to start training the AI. Every lead you log makes the system smarter â€” it learns which channels and copy convert best.', action: 'Log First Lead', actionFn: openModal },
                    { icon: 'ğŸ“‹', title: 'Your First A/B Test is Ready', text: 'Two default tests are set up: CNY promo vs problem-agitation copy, and emoji CTA vs direct CTA. As you log leads, tag which ad brought them in.', action: null }
                );
            }

            return { insights, brainLevel };
        }

        // ============================
        // TEMPLATES
        // ============================
        // ============================
        // SEASONAL CAMPAIGN ENGINE
        // ============================
        function getCurrentSeason() {
            const now = new Date();
            const m = now.getMonth() + 1; // 1-12
            const d = now.getDate();

            // CNY: Jan 15 - Feb 28
            if ((m === 1 && d >= 15) || (m === 2)) return {
                name: 'CNY', emoji: 'ğŸ§§', label: 'Chinese New Year Special',
                discount: '10% OFF', code: 'CNY', end: 'Feb 28',
                greeting: 'Gong Xi Fa Cai! ğŸ§§',
                hook: 'æ–°å¹´å¿«ä¹! Start the Year of the Snake with a FRESH home!'
            };
            // Hari Raya: Mar 1 - Apr 15
            if ((m === 3) || (m === 4 && d <= 15)) return {
                name: 'RAYA', emoji: 'ğŸŒ™', label: 'Hari Raya Special',
                discount: '10% OFF', code: 'RAYA', end: 'Apr 15',
                greeting: 'Selamat Hari Raya! ğŸŒ™',
                hook: 'Welcome guests to a sparkling home this Raya! âœ¨'
            };
            // Mother's Day: Apr 16 - May 15
            if ((m === 4 && d >= 16) || (m === 5 && d <= 15)) return {
                name: 'MOM', emoji: 'ğŸ’', label: "Mother's Day Special",
                discount: '$50 OFF', code: 'MOM', end: 'May 15',
                greeting: "Happy Mother's Day! ğŸ’",
                hook: "Give Mom the gift of a sparkling clean home she deserves!"
            };
            // National Day: Jul 1 - Aug 15
            if ((m === 7) || (m === 8 && d <= 15)) return {
                name: 'SG59', emoji: 'ğŸ‡¸ğŸ‡¬', label: 'National Day Special',
                discount: '$59 OFF', code: 'SG59', end: 'Aug 15',
                greeting: 'Happy National Day! ğŸ‡¸ğŸ‡¬',
                hook: 'Celebrate SG59 with a home transformation!'
            };
            // Year-End: Nov 1 - Dec 31
            if (m >= 11) return {
                name: 'YEAREND', emoji: 'ğŸ„', label: 'Year-End Blowout',
                discount: '15% OFF', code: 'YEAREND', end: 'Dec 31',
                greeting: 'Year-End Special! ğŸ„',
                hook: 'Start the new year with freshly grouted tiles!'
            };
            // Default (no festival)
            return {
                name: 'PROMO', emoji: 'âš¡', label: 'Limited Time Offer',
                discount: 'FREE tile cleaning', code: 'CLEAN', end: 'this month',
                greeting: 'Hi there! ğŸ‘‹',
                hook: 'Transform your home with premium epoxy grout!'
            };
        }

        function getTemplates() {
            const best = learnings.winPatterns.length > 0 ? learnings.winPatterns[learnings.winPatterns.length - 1].winner : null;
            const S = getCurrentSeason();

            return [
                {
                    platform: `Facebook Marketplace (${S.emoji} ${S.name})`, icon: 'ğŸª', copies: [
                        { label: 'Listing Title', text: `${S.emoji} ${S.discount} | Professional Epoxy Grout | From $488` },
                        { label: 'Description', text: `CLEANGROUT Professional Epoxy Grout Service\nâœ… Singapore island-wide & JB\n\n${S.emoji} ${S.label} â€” ${S.discount} (Ends ${S.end}!)\n\nğŸš¿ Bathroom â€” from $488\nğŸ³ Kitchen â€” from $588\nğŸ  Full Home â€” from $1,488\n\n100% waterproof â€¢ Anti-mold â€¢ 15-year life â€¢ Done in 1 day\n\nğŸ“± WhatsApp: 9800 4317\nğŸ’¬ DM "${S.code}" for special pricing!` }
                    ]
                },
                {
                    platform: `Facebook Ad (${S.emoji} ${S.name})`, icon: 'ğŸ“˜', copies: [
                        { label: best ? 'ğŸ† Winning Copy' : `Option A â€” ${S.label}`, text: best || `${S.emoji} ${S.label} â€” ${S.discount} (Ends ${S.end}!)\n\nYour grout is full of mold & stains? ğŸ˜±\n\nWe replace it with PREMIUM EPOXY GROUT:\nâœ… 100% Waterproof\nâœ… Anti-mold & stain-proof\nâœ… Lasts 15-20 years\nâœ… Done in 1 day\n\nğŸ”¥ Bathroom from $488 Â· Kitchen from $588 Â· Full Home from $1,488\n\nğŸ“± DM "${S.code}" for FREE quote â†’` },
                        { label: 'Option B â€” Problem', text: 'Is your bathroom grout DISGUSTING? ğŸ¤¢\n\nBlack mold. Yellow stains. Crumbling gaps.\nNo amount of scrubbing will fix cement grout.\n\nThe permanent solution? EPOXY GROUT.\nâœ… 100% waterproof\nâœ… Mold literally cannot grow\nâœ… From just $488\n\nğŸ“± WhatsApp us for FREE inspection â†’' }
                    ]
                },
                {
                    platform: 'WhatsApp Broadcast', icon: 'ğŸ“±', copies: [
                        { label: `${S.emoji} ${S.name} Blast`, text: `${S.greeting}\n\nCLEANGROUT is running a ${S.label} â€” ${S.discount} until ${S.end}!\n\nğŸš¿ Bathroom â€” from $488\nğŸ³ Kitchen â€” from $588\nğŸ  Full Home â€” from $1,488\n\nWant me to hold a slot for you? Reply YES and I'll book your free inspection! ğŸ˜Š` },
                        { label: 'Follow-Up', text: `Hi [Name]! Just following up on your epoxy grout enquiry ğŸ˜Š\n\nOur ${S.label} ends soon â€” shall I book your free inspection this week?\n\nNo obligation, we just assess and quote. Takes 15 min!` }
                    ]
                },
                {
                    platform: 'ğŸ“ Geo-Targeted: SINGAPORE ğŸ‡¸ğŸ‡¬', icon: 'ğŸ‡¸ğŸ‡¬', copies: [
                        { label: 'SG Facebook Ad', text: `${S.emoji} ${S.label} â€” Singapore Island-Wide!\n\nğŸ¢ HDB â€¢ Condo â€¢ Landed â€¢ Commercial\nWe serve ALL areas: Tampines, Woodlands, Jurong, Bedok, Ang Mo Kio, Punggol & more\n\nğŸš¿ Bathroom â€” from $488\nğŸ³ Kitchen â€” from $588\nğŸ  Full Home â€” from $1,488\n\nâœ… Same-day quote\nâœ… Premium Ardex/Sika epoxy\nâœ… Done in 1 day\n\nğŸ“± WhatsApp 9800 4317 or DM "${S.code}"` },
                        { label: 'SG Marketplace Listing', text: `ğŸ‡¸ğŸ‡¬ SINGAPORE ISLAND-WIDE | Professional Epoxy Grout\n\n${S.emoji} ${S.discount} â€” ${S.label}!\n\nServing: East, West, North, South, Central\nHDB âœ… Condo âœ… Landed âœ…\n\nFrom $488. Done in 1 day.\nğŸ“± 9800 4317` }
                    ]
                },
                {
                    platform: 'ğŸ“ Geo-Targeted: JOHOR BAHRU ğŸ‡²ğŸ‡¾', icon: 'ğŸ‡²ğŸ‡¾', copies: [
                        { label: 'JB Facebook Ad', text: `${S.emoji} ${S.label} â€” Now Serving Johor Bahru! ğŸ‡²ğŸ‡¾\n\nğŸ¢ JB residents get EXTRA 10% OFF on top!\n\nServing: JB City, Iskandar Puteri, Skudai, Kulai, Pasir Gudang, Masai & more\n\nğŸš¿ Bathroom â€” from RM1,599\nğŸ³ Kitchen â€” from RM1,999\nğŸ  Full Home â€” from RM4,999\n\nâœ… Same quality as our SG service\nâœ… Premium imported epoxy grout\nâœ… Done in 1 day\n\nğŸ“± WhatsApp +65 9800 4317` },
                        { label: 'JB Marketplace Listing', text: `ğŸ‡²ğŸ‡¾ JOHOR BAHRU | Professional Epoxy Grout Service\n\nFrom Singapore's trusted CLEANGROUT team!\n${S.emoji} ${S.discount} + Extra 10% JB Discount!\n\nServing all JB areas.\nFrom RM1,599. Done in 1 day.\nğŸ“± +65 9800 4317` }
                    ]
                },
                {
                    platform: 'Google My Business', icon: 'ğŸ“', copies: [
                        { label: 'GMB Update Post', text: `âœ¨ CLEANGROUT â€” Professional Epoxy Grout Service\n\n${S.emoji} ${S.label}: ${S.discount}!\n\nğŸš¿ Bathroom â€” from $488\nğŸ³ Kitchen â€” from $588\nğŸ  Full Home â€” from $1,488\n\nâœ… 100% waterproof\nâœ… Anti-mold & stain-proof\nâœ… Done in 1 day\nâœ… 15-20 year lifespan\n\nBook your FREE inspection today!\nğŸ“± WhatsApp: 9800 4317` },
                        { label: 'Review Request (After Job)', text: `Hi [Name]! Thank you so much for choosing CLEANGROUT! ğŸ™\n\nWe hope you love your new epoxy grout! Would you mind leaving us a quick Google review? It really helps other homeowners find us.\n\nğŸ‘‰ [Insert Google Review Link]\n\nThank you! ğŸ˜Š` }
                    ]
                },
                {
                    platform: 'TikTok / Reels / Shorts', icon: 'ğŸ¬', copies: [
                        { label: 'ASMR Grout Removal Caption', text: `10 years of mold... removed in 60 seconds ğŸ¤¢â¡ï¸âœ¨\n\n#asmr #groutcleaning #satisfying #oddlysatisfying #cleaningtiktok #beforeandafter #hdb #singapore #bathroomrenovation #cleaningasmr #transformation #sglife #epoxy` },
                        { label: 'Before/After Transformation', text: `POV: You finally fix your disgusting grout ğŸ˜±â¡ï¸ğŸ˜\n\nFrom $488 â€” link in bio\n\n#grout #epoxy #beforeandafter #homerenovation #satisfying #singapore #hdb #bathroomgoals #asmr #cleaningtiktok #diy` },
                        { label: 'Epoxy Application ASMR', text: `The sound of fresh epoxy grout... ğŸ¤¤\n\n100% waterproof. Zero mold. Lasts 15-20 years.\nFrom $488.\n\n#asmr #epoxy #grout #satisfying #oddlysatisfying #diy #renovation #singapore #hdb #cleaningtiktok #asmrsounds` }
                    ]
                },
                {
                    platform: 'ğŸ” Referral Engine', icon: 'ğŸ', copies: [
                        { label: 'Post-Job Referral Message', text: `Hi [Name]! Thank you for choosing CLEANGROUT! ğŸ™\n\nLoved our service? Share this with a friend!\n\nğŸ REFERRAL DEAL: When your friend books, you BOTH get $50 OFF your next service!\n\nJust tell them to mention your name when they WhatsApp us:\nğŸ“± 9800 4317\n\nOr share this link: https://epoxygrout.sg/?ref=[NAME]\n\nThank you for spreading the word! ğŸ™Œ` },
                        { label: 'Referral Reminder (2 weeks later)', text: `Hi [Name]! Hope you're still loving your new epoxy grout! âœ¨\n\nJust a reminder â€” if you refer a friend who books with us, you BOTH get $50 OFF! ğŸ\n\nSome ideas:\nâ€¢ Neighbours who've seen your new grout\nâ€¢ Family members with older HDB/condo\nâ€¢ Friends who complain about bathroom mold\n\nJust have them text us at 9800 4317 and mention your name! ğŸ˜Š` }
                    ]
                },
                {
                    platform: 'â­ Review Automation', icon: 'â­', copies: [
                        { label: 'Google Review Request (Day 1)', text: `Hi [Name]! ğŸ™\n\nThank you for choosing CLEANGROUT! We loved working on your [bathroom/kitchen/home].\n\nWould you mind leaving us a quick Google review? It takes just 30 seconds and helps other homeowners find us!\n\nâ­ Leave a review here: [Google Review Link]\n\nP.S. If you could mention the specific area we worked on (e.g. "bathroom grout"), it really helps our SEO! ğŸ˜Š` },
                        { label: 'Review Nudge (Day 3)', text: `Hi [Name]! Just a gentle follow-up ğŸ˜Š\n\nIf you haven't had a chance yet, we'd really appreciate a quick Google review:\n\nâ­ [Google Review Link]\n\nA few words about your experience would mean the world to us! ğŸ™\n\nEnjoy your new grout! âœ¨` },
                        { label: 'Photo Request (Day 7)', text: `Hi [Name]! Quick question ğŸ“¸\n\nWould you be okay with us using a before/after photo of your [bathroom/kitchen] on our social media?\n\nWe'll blur any personal items and just show the tile transformation. Your home looks amazing!\n\nIf yes, could you snap a quick photo of how it looks now? We'll send you a $20 voucher as thanks! ğŸ` }
                    ]
                }
            ];
        }

        // ============================
        // RENDER FUNCTIONS
        // ============================
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', ['dashboard', 'ab', 'leads', 'insights', 'content', 'analytics', 'templates'][i] === name);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            render();
        }

        function render() {
            evaluateTests();
            const { insights, brainLevel } = generateInsights();

            // Brain level
            const bl = document.getElementById('brainLevel');
            if (bl) {
                bl.textContent = brainLevel;
                bl.parentElement.innerHTML = `ğŸ§  Brain Level: <span>${brainLevel}</span>/10`;
            }

            // Stats
            const booked = leads.filter(l => l.status === 'Booked').length;
            document.getElementById('totalLeads').textContent = leads.length;
            document.getElementById('convRate').textContent = leads.length > 0 ? (booked / leads.length * 100).toFixed(0) + '%' : '0%';
            document.getElementById('revenue').textContent = '$' + leads.filter(l => l.status === 'Booked').reduce((s, l) => s + (PRICES[l.package] || 0), 0).toLocaleString();

            // Best channel
            const chMap = {};
            leads.forEach(l => {
                if (!chMap[l.channel]) chMap[l.channel] = { t: 0, b: 0 };
                chMap[l.channel].t++;
                if (l.status === 'Booked' || l.status === 'Hot') chMap[l.channel].b++;
            });
            let bestCh = 'â€”', bestR = 0;
            Object.entries(chMap).forEach(([c, d]) => { const r = d.b / d.t; if (r > bestR) { bestR = r; bestCh = c; } });
            document.getElementById('bestChannel').textContent = bestCh;
            document.getElementById('bestChannelRate').textContent = bestCh !== 'â€”' ? `${(bestR * 100).toFixed(0)}% hot/booked` : 'â€”';

            // Channel breakdown
            const chDiv = document.getElementById('channelBreakdown');
            chDiv.innerHTML = Object.entries(chMap).map(([ch, d]) => `
        <div class="stat-card">
            <div class="stat-label">${ch}</div>
            <div class="stat-value" style="font-size:24px">${d.t}</div>
            <div class="stat-change ${d.b / d.t > 0.3 ? 'stat-up' : ''}">${(d.b / d.t * 100).toFixed(0)}% converting</div>
        </div>
    `).join('');

            // Recent leads
            const rl = document.getElementById('recentLeads');
            const recent = [...leads].reverse().slice(0, 5);
            rl.innerHTML = recent.length ? `<table class="lead-table"><thead><tr><th>Name</th><th>Channel</th><th>Status</th><th>Package</th></tr></thead><tbody>${recent.map(l => `<tr><td>${esc(l.name)}</td><td><span class="channel-badge ch-${l.channel.toLowerCase().replace(/\s/g, '')}">${l.channel}</span></td><td><span class="status-${l.status.toLowerCase()}">${l.status}</span></td><td>${l.package}</td></tr>`).join('')
                }</tbody></table>` : '<p style="color:#777">No leads yet. Click "+ Log Lead" to start!</p>';

            renderTests();
            renderLeads();
            renderInsights(insights);
            renderContentStudio();
            renderAnalytics();
            renderTemplates();
            renderFollowUps();
            updateAdCopyDropdown();
        }

        function renderTests() {
            const active = tests.filter(t => t.status === 'running');
            const completed = tests.filter(t => t.status === 'completed');

            document.getElementById('abTests').innerHTML = active.length ? active.map(t => renderTestCard(t)).join('') : '<p style="color:#777">No active tests. Create one to start optimizing!</p>';
            document.getElementById('completedTests').innerHTML = completed.length ? completed.map(t => renderTestCard(t)).join('') : '<p style="color:#777">No completed tests yet. Tests complete when both variants reach the minimum lead count.</p>';
        }

        function renderTestCard(t) {
            const totalA = t.leadsA, totalB = t.leadsB;
            const rateA = totalA > 0 ? (t.convA / totalA * 100).toFixed(0) : 0;
            const rateB = totalB > 0 ? (t.convB / totalB * 100).toFixed(0) : 0;
            const pctA = (totalA + totalB) > 0 ? totalA / (totalA + totalB) * 100 : 50;

            return `<div class="test-grid"><div class="test-card ${t.winner === 'A' ? 'winner' : t.winner === 'B' ? 'loser' : ''}">
        <span class="test-badge ${t.winner === 'A' ? 'badge-winner' : t.winner === 'B' ? 'badge-loser' : 'badge-running'}">${t.winner === 'A' ? 'ğŸ‘‘ WINNER' : t.winner === 'B' ? 'LOSER' : 'RUNNING'}</span>
        <div class="test-variant">Variant A â€” ${t.name}</div>
        <div class="test-copy">"${t.copyA.substring(0, 120)}..."</div>
        <div class="test-metrics">
            <div class="test-metric"><div class="test-metric-val">${totalA}</div><div class="test-metric-label">Leads</div></div>
            <div class="test-metric"><div class="test-metric-val">${t.convA}</div><div class="test-metric-label">Converted</div></div>
            <div class="test-metric"><div class="test-metric-val">${rateA}%</div><div class="test-metric-label">Conv Rate</div></div>
        </div>
        <div class="progress-bar"><div class="progress-fill fill-a" style="width:${pctA}%"></div></div>
    </div><div class="test-card ${t.winner === 'B' ? 'winner' : t.winner === 'A' ? 'loser' : ''}">
        <span class="test-badge ${t.winner === 'B' ? 'badge-winner' : t.winner === 'A' ? 'badge-loser' : 'badge-running'}">${t.winner === 'B' ? 'ğŸ‘‘ WINNER' : t.winner === 'A' ? 'LOSER' : 'RUNNING'}</span>
        <div class="test-variant">Variant B â€” ${t.name}</div>
        <div class="test-copy">"${t.copyB.substring(0, 120)}..."</div>
        <div class="test-metrics">
            <div class="test-metric"><div class="test-metric-val">${totalB}</div><div class="test-metric-label">Leads</div></div>
            <div class="test-metric"><div class="test-metric-val">${t.convB}</div><div class="test-metric-label">Converted</div></div>
            <div class="test-metric"><div class="test-metric-val">${rateB}%</div><div class="test-metric-label">Conv Rate</div></div>
        </div>
        <div class="progress-bar"><div class="progress-fill fill-b" style="width:${100 - pctA}%"></div></div>
    </div></div>`;
        }

        function renderLeads() {
            const filter = document.getElementById('filterChannel').value;
            const filtered = filter === 'all' ? leads : leads.filter(l => l.channel === filter);
            const tbody = document.getElementById('leadTableBody');
            tbody.innerHTML = [...filtered].reverse().map((l, i) => {
                const idx = leads.indexOf(l);
                return `<tr>
        <td style="font-size:13px;color:#999">${new Date(l.date).toLocaleDateString()}</td>
        <td>${esc(l.name)}</td>
        <td><span class="channel-badge ch-${l.channel.toLowerCase().replace(/\s/g, '')}">${l.channel}</span></td>
        <td style="font-size:12px;color:#777;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(l.adCopy || 'â€”')}</td>
        <td><span class="status-${l.status.toLowerCase()}">${l.status}</span></td>
        <td>${PRICES[l.package] ? '$' + PRICES[l.package] : 'â€”'}</td>
        <td style="display:flex;gap:4px;align-items:center"><select onchange="updateLeadStatus(${idx},this.value)" style="padding:4px 8px;background:#1a1a1a;border:1px solid #333;border-radius:4px;color:#fff;font-size:12px">
            <option ${l.status === 'Hot' ? 'selected' : ''} value="Hot">ğŸ”¥ Hot</option>
            <option ${l.status === 'Warm' ? 'selected' : ''} value="Warm">ğŸŸ¡ Warm</option>
            <option ${l.status === 'Cold' ? 'selected' : ''} value="Cold">âšª Cold</option>
            <option ${l.status === 'Booked' ? 'selected' : ''} value="Booked">âœ… Booked</option>
        </select><button onclick="deleteLead(${idx})" style="background:none;border:none;color:#555;cursor:pointer;font-size:14px" title="Delete">ğŸ—‘</button></td>
    </tr>`}).join('');
        }

        // Store action functions for insight buttons
        window._insightActions = {};
        function renderInsights(insights) {
            insights.forEach((ins, idx) => { if (ins.actionFn) window._insightActions[idx] = ins.actionFn; });
            document.getElementById('insightsPanel').innerHTML = insights.map((i, idx) => `
        <div class="insight-card">
            <h4>${i.icon} ${i.title}</h4>
            <p>${i.text}</p>
            ${i.action ? `<button class="action" onclick="window._insightActions[${idx}]()">${i.action}</button>` : ''}
        </div>
    `).join('');
        }

        // Store template texts for safe copy
        window._templateTexts = [];
        function renderTemplates() {
            const templates = getTemplates();
            window._templateTexts = [];
            let idx = 0;
            document.getElementById('templatesPanel').innerHTML = templates.map(t => `
        <div style="margin-bottom:24px">
            <h4 style="margin-bottom:12px">${t.icon} ${t.platform}</h4>
            ${t.copies.map(c => {
                const i = idx++;
                window._templateTexts[i] = c.text;
                return `
                <div class="test-card" style="margin-bottom:12px">
                    <div class="test-variant">${c.label}</div>
                    <pre style="font-family:'Inter',sans-serif;font-size:13px;color:#ccc;white-space:pre-wrap;line-height:1.6;margin:8px 0">${c.text}</pre>
                    <button class="btn btn-outline" style="font-size:11px;padding:6px 12px" onclick="copyTemplate(${i},this)">ğŸ“‹ Copy</button>
                </div>
            `}).join('')}
        </div>
    `).join('');
        }
        function copyTemplate(idx, btn) {
            navigator.clipboard.writeText(window._templateTexts[idx]).then(() => { btn.textContent = 'âœ… Copied!'; setTimeout(() => btn.textContent = 'ğŸ“‹ Copy', 2000); });
        }

        // ============================
        // CONTENT STUDIO â€” ASMR + CALENDAR + SCRIPTS
        // ============================
        function renderContentStudio() {
            const panel = document.getElementById('contentStudioPanel');
            if (!panel) return;

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const topStyle = learnings.winPatterns.length > 0 ?
                Object.entries(analyzeStyle(learnings.winPatterns[learnings.winPatterns.length - 1].winner))
                    .sort((a, b) => b[1] - a[1])[0]?.[0] : null;

            // ASMR Video Ideas
            const asmrIdeas = [
                { title: 'ğŸ§ "Removing 10-year-old grout" ASMR', script: 'Setup: Phone on tripod, close-up angle on tile gap.\n\n1. Show the dirty grout (zoom in on mold) â€” 3 sec\n2. Start scraping with grout removal tool â€” 15 sec (the MONEY sound)\n3. Pan to show progress line â€” 3 sec\n4. Speed-up the rest â€” 10 sec\n5. Show clean gap ready for epoxy â€” 3 sec\n\nCaption: "10 years of filth... gone ğŸ¤¢â¡ï¸âœ¨"\nNo music. Just the raw scraping sound.', platform: 'TikTok + Reels + Shorts', hashtags: '#asmr #groutcleaning #satisfying #oddlysatisfying #cleaningtiktok #hdb #singapore' },
                { title: 'ğŸ¤¤ "Fresh epoxy application" ASMR', script: 'Setup: Overhead camera angle, good lighting.\n\n1. Show clean tile gaps (from removal) â€” 2 sec\n2. Scoop epoxy onto rubber float â€” 3 sec\n3. Slow diagonal spread across tiles â€” 20 sec (smooth ASMR)\n4. Second pass from other angle â€” 10 sec\n5. Close-up of filled gaps â€” 3 sec\n\nCaption: "The sound of waterproof perfection ğŸ¤¤"\nNo music. Ambient work sounds only.', platform: 'TikTok + Reels + Shorts', hashtags: '#asmr #epoxy #satisfying #oddlysatisfying #renovation #asmrsounds' },
                { title: 'ğŸ§½ "The Haze Wipe Reveal" ASMR', script: 'Setup: Side angle, capture the wipe motion.\n\n1. Show haze-covered tiles (looks messy) â€” 3 sec\n2. Wet sponge squeeze sound â€” 2 sec\n3. First slow wipe â€” tiles emerge GLEAMING â€” 8 sec\n4. Continue wiping row by row â€” 15 sec\n5. Final wide shot of clean tiles â€” 5 sec\n\nCaption: "The most satisfying part of Every. Single. Job. ğŸ˜"\nNo music. Sponge + water sounds.', platform: 'TikTok + Reels + Shorts', hashtags: '#satisfying #cleaning #beforeandafter #reveal #transformation' },
                { title: 'â© "Full Bathroom in 60 Seconds" Timelapse', script: 'Setup: Wide angle covering full bathroom.\n\n1. Before shot â€” dirty grout close-ups (5 sec)\n2. Text overlay: "10-year-old HDB bathroom"\n3. Timelapse of removal â†’ cleaning â†’ application â†’ wiping (45 sec)\n4. Slow-mo final pan of completed bathroom (10 sec)\n5. Text: "From $439. WhatsApp link in bio."\n\nAudio: Trending audio OR satisfying ASMR sounds', platform: 'TikTok + Reels + Shorts', hashtags: '#timelapse #renovation #hdb #singapore #beforeandafter #transformation' },
                { title: 'ğŸ“ "Split Screen Before/After"', script: 'Setup: Same angle, before and after.\n\n1. Film same tiles BEFORE (dirty, moldy) â€” 5 sec\n2. BLACK SCREEN "4 hours later..." â€” 2 sec\n3. Film EXACT same angle AFTER â€” 5 sec\n4. Side-by-side split screen comparison â€” 8 sec\n5. Text: "Same bathroom. Same tiles. Different grout."\n\nCaption: "You don\'t need new tiles. You need new grout."\nAudio: Trending satisfying sound', platform: 'TikTok + Reels + Shorts', hashtags: '#beforeandafter #grout #renovation #hdb #satisfying #homemakeover' },
                { title: 'ğŸ”¬ "What Lives in Your Grout" (Shock Content)', script: 'Setup: Macro lens or close-up phone camera.\n\n1. Normal bathroom shot â€” looks ok from far (3 sec)\n2. Text: "Looks clean, right? Let\'s zoom in..."\n3. Extreme close-up of grout line â€” mold, discoloration (5 sec)\n4. Text: "2x more bacteria than a toilet seat"\n5. Speed-up of the cleaning + epoxy process (15 sec)\n6. Macro shot of new epoxy grout â€” pristine (5 sec)\n\nCaption: "You can\'t unsee this ğŸ˜± #grout"\nAudio: Ominous sound â†’ satisfying reveal', platform: 'TikTok + Reels + Shorts', hashtags: '#gross #bacteria #cleaning #satisfying #beforeandafter #grout #singapore' }
            ];

            // Content Calendar (7 days)
            const contentTypes = [
                { type: 'ğŸ“¸ Before/After Post', platform: 'IG + FB', color: '#4CAF50' },
                { type: 'ğŸ§ ASMR Video', platform: 'TikTok + Reels', color: '#E91E63' },
                { type: 'ğŸ’° Promo/Price Post', platform: 'FB + Marketplace', color: '#FF9800' },
                { type: 'â­ Customer Review', platform: 'IG Stories + GMB', color: '#2196F3' },
                { type: 'ğŸ§ ASMR Video', platform: 'TikTok + Reels', color: '#E91E63' },
                { type: 'ğŸ“‹ Educational (Tips)', platform: 'IG Carousel + FB', color: '#9C27B0' },
                { type: 'ğŸ¤¢ Problem/Shock Post', platform: 'TikTok + FB', color: '#f44336' }
            ];

            // Job-based filming suggestions
            const bookedLeads = leads.filter(l => l.status === 'Booked');
            let filmingSuggestion = '';
            if (bookedLeads.length > 0) {
                const lastBooked = bookedLeads[bookedLeads.length - 1];
                filmingSuggestion = `
                <div class="test-card" style="border-left:4px solid #E91E63;margin-bottom:24px">
                    <h4 style="color:#E91E63;margin-bottom:8px">ğŸ¬ FILM NEXT JOB: ${esc(lastBooked.name)} (${lastBooked.package})</h4>
                    <p style="color:#aaa;font-size:13px;margin-bottom:12px">You have a ${lastBooked.package} job booked. Here's what to film:</p>
                    <div style="display:grid;gap:8px;font-size:13px;color:#ccc">
                        <div>ğŸ“± <strong>Video 1:</strong> Before shot â€” close-up of dirty grout (10 sec)</div>
                        <div>ğŸ“± <strong>Video 2:</strong> ASMR grout removal (30 sec, no music)</div>
                        <div>ğŸ“± <strong>Video 3:</strong> Epoxy application smooth pass (20 sec)</div>
                        <div>ğŸ“± <strong>Video 4:</strong> Haze wipe reveal (15 sec)</div>
                        <div>ğŸ“± <strong>Video 5:</strong> Wide after shot + customer reaction (10 sec)</div>
                    </div>
                    <p style="color:#777;font-size:12px;margin-top:12px">ğŸ’¡ That's 5 pieces of content from 1 job = 1 week of posts!</p>
                </div>`;
            }

            panel.innerHTML = `
                ${filmingSuggestion}

                <h4 style="margin-bottom:16px">ğŸ“… 7-Day Content Calendar</h4>
                <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:30px">
                    ${[0, 1, 2, 3, 4, 5, 6].map(i => {
                const d = new Date(today); d.setDate(d.getDate() + i);
                const ct = contentTypes[(d.getDay()) % 7];
                const isToday = i === 0;
                return `<div class="test-card" style="text-align:center;padding:12px 8px;${isToday ? 'border:1px solid #D32F2F' : ''}">
                            <div style="font-size:11px;color:#777;margin-bottom:4px">${isToday ? 'â¬…ï¸ TODAY' : days[d.getDay()]} ${d.getDate()}/${d.getMonth() + 1}</div>
                            <div style="font-size:20px;margin:8px 0">${ct.type.split(' ')[0]}</div>
                            <div style="font-size:11px;color:${ct.color};font-weight:600">${ct.type.split(' ').slice(1).join(' ')}</div>
                            <div style="font-size:10px;color:#555;margin-top:4px">${ct.platform}</div>
                        </div>`;
            }).join('')}
                </div>

                ${topStyle ? `<div class="insight-card" style="margin-bottom:24px">
                    <h4>ğŸ§  Your Winning Style: ${MSG_STYLES[topStyle]?.label || topStyle}</h4>
                    <p>Focus your content on this style â€” it converts best with your audience. Mix it into your ASMR captions and post copy.</p>
                </div>` : ''}

                <h4 style="margin-bottom:16px">ğŸ§ ASMR Video Scripts (Ready to Film)</h4>
                ${asmrIdeas.map((idea, idx) => `
                    <div class="test-card" style="margin-bottom:16px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <h4 style="margin:0">${idea.title}</h4>
                            <span style="font-size:11px;color:#777">${idea.platform}</span>
                        </div>
                        <pre style="font-family:'Inter',sans-serif;font-size:12px;color:#ccc;white-space:pre-wrap;line-height:1.6;margin:8px 0;background:#0d0d0d;padding:12px;border-radius:6px">${idea.script}</pre>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <span style="font-size:11px;color:#777">${idea.hashtags}</span>
                        </div>
                    </div>
                `).join('')}

                <h4 style="margin:24px 0 16px">ğŸ’¡ Pro Tips for ASMR Grout Videos</h4>
                <div class="test-card">
                    <div style="display:grid;gap:10px;font-size:13px;color:#ccc">
                        <div>ğŸ¯ <strong>Best time to post:</strong> 7-9 PM SGT (TikTok), 12-2 PM (IG Reels)</div>
                        <div>ğŸ”Š <strong>Audio:</strong> NO background music for ASMR. Raw tool sounds = more views</div>
                        <div>ğŸ“± <strong>Phone setup:</strong> Prop against wall or cheap tripod. Landscape for YouTube, portrait for TikTok</div>
                        <div>â±ï¸ <strong>Length:</strong> 15-30 sec for TikTok, 30-60 sec for Reels, 60 sec+ for YouTube Shorts</div>
                        <div>ğŸ“ <strong>Caption formula:</strong> Hook (shock/curiosity) + Result + CTA + Hashtags</div>
                        <div>ğŸ”„ <strong>Repurpose:</strong> 1 job = 5 clips. Post same clip to TikTok, Reels, AND Shorts</div>
                        <div>ğŸ“Š <strong>Track results:</strong> Log "TikTok" as channel when leads mention your videos</div>
                    </div>
                </div>

                <h4 style="margin:30px 0 16px">ğŸ› ï¸ Free Tools â€” Everything You Need (No Subscriptions)</h4>
                <p style="color:#777;font-size:13px;margin-bottom:16px">All free or open-source. Click any tool name to open it.</p>

                <div style="margin-bottom:20px">
                    <h5 style="color:#E91E63;margin-bottom:12px">ğŸ¬ Video Editing (for ASMR & Reels)</h5>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.capcut.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">CapCut</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Best for TikTok/Reels editing. Auto-captions, trending templates, split-screen. Used by 90% of TikTok creators.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.blackmagicdesign.com/products/davinciresolve" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">DaVinci Resolve</a>
                            <span style="background:#4CAF50;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Hollywood-grade color correction. Professional before/after comparisons. Free version is incredibly powerful.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.openshot.org" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">OpenShot</a>
                            <span style="background:#2196F3;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">OPEN SOURCE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Simple drag-and-drop video editor. Perfect for quick timelapses and basic edits.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://kdenlive.org" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Kdenlive</a>
                            <span style="background:#2196F3;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">OPEN SOURCE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Multi-track video editor. Great for combining multiple ASMR clips into one video.</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:20px">
                    <h5 style="color:#FF9800;margin-bottom:12px">ğŸ¨ Design & Graphics (for Posts & Thumbnails)</h5>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.canva.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Canva</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Drag-and-drop design. Before/after templates, IG story templates, FB ad graphics. AI image generation included.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.gimp.org" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">GIMP</a>
                            <span style="background:#2196F3;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">OPEN SOURCE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Free Photoshop alternative. Edit before/after photos, add watermarks, create ad images.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://inkscape.org" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Inkscape</a>
                            <span style="background:#2196F3;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">OPEN SOURCE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Vector graphics editor for logos, flyers, and business cards. Professional print-quality output.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.remove.bg" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Remove.bg</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Instantly remove image backgrounds. Perfect for product shots and testimonial graphics.</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:20px">
                    <h5 style="color:#9C27B0;margin-bottom:12px">ğŸ“… Social Media Scheduling</h5>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="test-card" style="padding:12px">
                            <a href="https://business.facebook.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Meta Business Suite</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Schedule FB + IG posts, manage inbox, view analytics. THE essential free tool for FB/IG businesses.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://postiz.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Postiz</a>
                            <span style="background:#2196F3;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">OPEN SOURCE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Self-hosted social media scheduler. AI-powered content suggestions. Full control over your data.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://buffer.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Buffer</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Schedule 3 channels, 10 posts each. Simple and clean UI. Best for getting started with scheduling.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://later.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Later</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Visual content calendar. Drag-and-drop scheduling. Best for planning IG grid aesthetics.</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:20px">
                    <h5 style="color:#4CAF50;margin-bottom:12px">ğŸ“Š Lead Gen & CRM</h5>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.hubspot.com/products/crm" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">HubSpot CRM</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Unlimited contacts. Email tracking, meeting scheduling, deal pipeline. Industry standard free CRM.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://www.bitrix24.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Bitrix24</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE TIER</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Free CRM + website builder + online forms. Captures leads from your website automatically.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://business.google.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">Google Business Profile</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Show up in Google Maps & Search. Post updates, collect reviews, get leads. MUST HAVE for local businesses.</div>
                        </div>
                        <div class="test-card" style="padding:12px">
                            <a href="https://business.whatsapp.com" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">WhatsApp Business</a>
                            <span style="background:#25D366;color:#fff;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">FREE</span>
                            <div style="font-size:11px;color:#999;margin-top:4px">Business profile, quick replies, labels, catalogs, broadcast lists. Essential for SG market.</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================
        // FOLLOW-UP REMINDERS
        // ============================
        function renderFollowUps() {
            const panel = document.getElementById('followUpPanel');
            if (!panel) return;

            const now = new Date();
            const needFollowUp = leads.filter(l => {
                if (l.status === 'Booked' || l.status === 'Cold') return false;
                const daysSince = (now - new Date(l.date)) / 86400000;
                return daysSince >= 2 && daysSince < 30;
            });

            if (needFollowUp.length === 0) {
                panel.innerHTML = '<p style="color:#777;font-size:13px">No leads need follow-up right now ğŸ‘</p>';
                return;
            }

            panel.innerHTML = needFollowUp.map(l => {
                const daysSince = Math.floor((now - new Date(l.date)) / 86400000);
                const urgency = daysSince >= 7 ? '#f44336' : daysSince >= 4 ? '#FF9800' : '#4CAF50';
                return `
                <div class="test-card" style="margin-bottom:8px;border-left:3px solid ${urgency};display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong style="color:#fff">${esc(l.name)}</strong>
                        <span style="color:#777;font-size:12px;margin-left:8px">${l.channel} Â· ${l.package} Â· ${daysSince}d ago</span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <a href="https://wa.me/65${l.phone?.replace(/\D/g, '').slice(-8) || '98004317'}?text=${encodeURIComponent('Hi ' + (l.name || '') + '! Just following up on your epoxy grout enquiry ğŸ˜Š Shall I book your free inspection?')}" target="_blank"
                           style="padding:6px 12px;background:#25D366;color:#fff;border-radius:4px;font-size:11px;font-weight:600;text-decoration:none">ğŸ“± WhatsApp</a>
                        <button onclick="markFollowedUp(${leads.indexOf(l)})" style="padding:6px 12px;background:#333;color:#fff;border:none;border-radius:4px;font-size:11px;cursor:pointer">âœ… Done</button>
                    </div>
                </div>`;
            }).join('');
        }

        function markFollowedUp(idx) {
            if (leads[idx]) {
                leads[idx].lastFollowUp = new Date().toISOString();
                leads[idx].notes = (leads[idx].notes || '') + ' | Followed up ' + new Date().toLocaleDateString();
                setData('leads', leads);
                render();
            }
        }

        // ============================
        // ANALYTICS â€” SEO, AEO & TRACKING
        // ============================
        function renderAnalytics() {
            const panel = document.getElementById('analyticsPanel');
            if (!panel) return;

            // Read tracking events from localStorage
            const events = JSON.parse(localStorage.getItem('cg_events') || '[]');
            const unanswered = JSON.parse(localStorage.getItem('cg_unanswered') || '[]');

            // Event counts
            const evCounts = {};
            events.forEach(e => { evCounts[e.event] = (evCounts[e.event] || 0) + 1; });

            // Recent events (last 20)
            const recentEvents = [...events].reverse().slice(0, 20);

            // Channel attribution from leads
            const channelCounts = {};
            leads.forEach(l => { channelCounts[l.channel] = (channelCounts[l.channel] || 0) + 1; });
            const sortedChannels = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]);

            // SEO Scorecard
            const seoChecks = [
                { label: 'LocalBusiness Schema', status: true, tip: 'JSON-LD structured data for Google Business listing' },
                { label: 'FAQPage Schema (7 FAQs)', status: true, tip: 'FAQ rich snippets â€” your questions appear in Google Search' },
                { label: 'HowTo Schema (4-step process)', status: true, tip: 'Step-by-step rich snippets for "how epoxy grout works"' },
                { label: 'AggregateRating Schema', status: true, tip: 'â­ Stars show in Google Search results' },
                { label: 'Open Graph Tags', status: true, tip: 'FB/IG link previews work properly' },
                { label: 'Twitter Card Tags', status: true, tip: 'Twitter/X link previews work' },
                { label: 'Geo-targeting Meta', status: true, tip: 'Google knows you serve Singapore & JB' },
                { label: 'Canonical URL', status: true, tip: 'Prevents duplicate content penalties' },
                { label: 'Meta Pixel', status: events.some(e => e.event === 'PageView'), tip: 'Replace YOUR_PIXEL_ID in index.html' },
                { label: 'GA4 Analytics', status: false, tip: 'Replace G-XXXXXXXXXX in index.html' },
                { label: 'Lead Event Tracking', status: evCounts['Lead'] > 0, tip: 'Fires when chatbot captures a lead' },
                { label: 'Contact Event Tracking', status: evCounts['Contact'] > 0, tip: 'Fires on WhatsApp clicks' }
            ];
            const seoScore = seoChecks.filter(c => c.status).length;
            const seoTotal = seoChecks.length;
            const seoColor = seoScore >= 10 ? '#4CAF50' : seoScore >= 7 ? '#FF9800' : '#f44336';

            // UTM generator data
            const baseUrl = 'https://epoxygrout.sg';
            const utmTemplates = [
                { name: 'Facebook Ad â€” CNY Promo', source: 'facebook', medium: 'paid', campaign: 'cny_2026', content: 'cny_promo' },
                { name: 'Facebook Ad â€” Problem Copy', source: 'facebook', medium: 'paid', campaign: 'cny_2026', content: 'problem_copy' },
                { name: 'Facebook Marketplace', source: 'facebook', medium: 'marketplace', campaign: 'organic', content: 'listing' },
                { name: 'Instagram Reels', source: 'instagram', medium: 'organic', campaign: 'content', content: 'reel' },
                { name: 'TikTok ASMR Video', source: 'tiktok', medium: 'organic', campaign: 'asmr', content: 'video' },
                { name: 'Google My Business', source: 'google', medium: 'gmb', campaign: 'local', content: 'gmb_post' },
                { name: 'WhatsApp Broadcast', source: 'whatsapp', medium: 'broadcast', campaign: 'followup', content: 'blast' },
                { name: 'YouTube Shorts', source: 'youtube', medium: 'organic', campaign: 'shorts', content: 'asmr' }
            ];

            panel.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:24px">
                    <div class="stat-card">
                        <div class="stat-label">SEO Score</div>
                        <div class="stat-value" style="color:${seoColor}">${seoScore}/${seoTotal}</div>
                        <div class="stat-change">${seoScore >= 10 ? 'ğŸŸ¢ Excellent' : seoScore >= 7 ? 'ğŸŸ¡ Good' : 'ğŸ”´ Needs Work'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Events</div>
                        <div class="stat-value">${events.length}</div>
                        <div class="stat-change">Meta + GA4 events fired</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Leads Tracked</div>
                        <div class="stat-value">${evCounts['Lead'] || 0}</div>
                        <div class="stat-change stat-up">Pixel Lead events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">WA Clicks</div>
                        <div class="stat-value">${evCounts['Contact'] || 0}</div>
                        <div class="stat-change stat-up">Contact events</div>
                    </div>
                </div>

                <h4 style="margin-bottom:12px">âœ… SEO & Tracking Scorecard</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:24px">
                    ${seoChecks.map(c => `
                        <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">${c.status ? 'âœ…' : 'âŒ'}</span>
                            <div>
                                <div style="font-size:12px;font-weight:600;color:${c.status ? '#4CAF50' : '#f44336'}">${c.label}</div>
                                <div style="font-size:10px;color:#666">${c.tip}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${!events.some(e => e.event === 'PageView') ? `
                <div class="test-card" style="border-left:4px solid #f44336;margin-bottom:24px">
                    <h4 style="color:#f44336;margin-bottom:8px">âš ï¸ Meta Pixel Not Active</h4>
                    <p style="color:#aaa;font-size:13px;margin-bottom:12px">Replace <code style="background:#222;padding:2px 6px;border-radius:3px">YOUR_PIXEL_ID</code> in index.html with your actual Pixel ID from:</p>
                    <a href="https://business.facebook.com/events-manager" target="_blank" style="color:#4CAF50;font-size:13px">â†’ Meta Business Suite â†’ Events Manager â†’ Data Sources</a>
                    <p style="color:#666;font-size:11px;margin-top:8px">Same for GA4: replace <code style="background:#222;padding:2px 6px;border-radius:3px">G-XXXXXXXXXX</code> with your GA4 ID from analytics.google.com</p>
                </div>` : ''}

                <h4 style="margin:24px 0 12px">ğŸ“Š Channel Attribution</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:24px">
                    ${sortedChannels.length > 0 ? sortedChannels.map(([ch, count]) => {
                const pct = (count / leads.length * 100).toFixed(0);
                return `<div class="test-card" style="text-align:center;padding:12px">
                            <div style="font-size:22px;font-weight:700;color:#fff">${count}</div>
                            <div style="font-size:12px;color:#aaa">${ch}</div>
                            <div style="height:4px;background:#222;border-radius:2px;margin-top:6px;overflow:hidden">
                                <div style="height:100%;width:${pct}%;background:#D32F2F;border-radius:2px"></div>
                            </div>
                            <div style="font-size:10px;color:#666;margin-top:4px">${pct}%</div>
                        </div>`;
            }).join('') : '<p style="color:#777;font-size:13px;grid-column:1/-1">No leads yet â€” attribution data will appear as you log leads.</p>'}
                </div>

                <h4 style="margin:24px 0 12px">ğŸ”— UTM Link Generator (Auto-Tracked URLs)</h4>
                <p style="color:#777;font-size:12px;margin-bottom:12px">Copy these URLs and use them instead of plain epoxygrout.sg links. GA4 will show you exactly which channel brought each visitor.</p>
                <div style="display:grid;gap:6px;margin-bottom:24px">
                    ${utmTemplates.map((u, i) => {
                const url = baseUrl + '/?utm_source=' + u.source + '&utm_medium=' + u.medium + '&utm_campaign=' + u.campaign + '&utm_content=' + u.content;
                return `<div class="test-card" style="padding:10px;display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#fff">${u.name}</div>
                                <div style="font-size:10px;color:#555;word-break:break-all;margin-top:2px">${url}</div>
                            </div>
                            <button class="btn btn-outline" style="font-size:10px;padding:4px 10px;white-space:nowrap" onclick="navigator.clipboard.writeText('${url}').then(()=>{this.textContent='âœ…';setTimeout(()=>this.textContent='ğŸ“‹ Copy',1500)})">ğŸ“‹ Copy</button>
                        </div>`;
            }).join('')}
                </div>

                <h4 style="margin:24px 0 12px">ğŸ§  AEO Pipeline â€” Chatbot FAQ Mining</h4>
                <p style="color:#777;font-size:12px;margin-bottom:12px">These are questions visitors asked the chatbot that it couldn't answer. Add the best ones to your FAQ schema â†’ Google uses this for AI-generated snippets.</p>
                ${unanswered.length > 0 ? `
                <div style="display:grid;gap:6px;margin-bottom:24px">
                    ${[...unanswered].reverse().slice(0, 15).map((q, i) => `
                        <div class="test-card" style="padding:10px;display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <span style="font-size:13px;color:#fff">"${esc(q.q)}"</span>
                                <span style="font-size:10px;color:#555;margin-left:8px">${new Date(q.ts).toLocaleDateString()}</span>
                            </div>
                            <span style="font-size:11px;color:#FF9800">ğŸ’¡ Add to FAQ</span>
                        </div>
                    `).join('')}
                </div>
                <p style="color:#555;font-size:11px">ğŸ’¡ To add a question to your FAQ schema: update the FAQPage JSON-LD in index.html (line ~88). Each new FAQ = another chance to appear in Google's featured snippets.</p>
                ` : '<p style="color:#777;font-size:13px;margin-bottom:24px">No unanswered questions yet. As visitors use your chatbot, unmatched questions will appear here.</p>'}

                <h4 style="margin:24px 0 12px">ğŸ“¡ Recent Conversion Events</h4>
                ${recentEvents.length > 0 ? `
                <div style="display:grid;gap:4px;margin-bottom:24px">
                    ${recentEvents.map(e => {
                const evColor = e.event === 'Lead' ? '#4CAF50' : e.event === 'Contact' ? '#25D366' : e.event === 'InitiateCheckout' ? '#FF9800' : e.event === 'PageView' ? '#2196F3' : '#9C27B0';
                return `<div class="test-card" style="padding:8px 12px;display:flex;justify-content:space-between;align-items:center">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="background:${evColor};color:#fff;font-size:9px;padding:2px 8px;border-radius:3px;font-weight:700">${e.event}</span>
                                <span style="font-size:11px;color:#aaa">${e.data?.content_name || e.data?.search_string || ''}</span>
                            </div>
                            <span style="font-size:10px;color:#555">${new Date(e.ts).toLocaleString()}</span>
                        </div>`;
            }).join('')}
                </div>
                ` : '<p style="color:#777;font-size:13px">No events yet. Visit your main site (index.html) to see PageView events appear here.</p>'}

                <h4 style="margin:24px 0 12px">ğŸŒ Geo-Targeting â€” Singapore & JB Only</h4>
                <p style="color:#777;font-size:12px;margin-bottom:12px">Follow these exact steps to restrict your ads to ONLY Singapore and Johor Bahru. This prevents wasting money on clicks from people outside your service area.</p>
                <div style="display:grid;gap:8px;margin-bottom:24px">
                    <div class="test-card" style="padding:14px;border-left:4px solid #2196F3">
                        <h5 style="color:#2196F3;margin-bottom:8px">ğŸ“˜ Facebook / Instagram Ads</h5>
                        <ol style="color:#ccc;font-size:12px;padding-left:16px;line-height:1.8">
                            <li>Go to <a href="https://adsmanager.facebook.com" target="_blank" style="color:#4CAF50">Ads Manager</a> â†’ Create Campaign</li>
                            <li>At Ad Set level â†’ <strong>Locations</strong> section</li>
                            <li>Change "Living in or recently in" to <strong>"People living in this location"</strong> (prevents tourists)</li>
                            <li>Type <strong>"Singapore"</strong> â†’ select country â†’ set radius to <strong>+0 km</strong> (exact country border)</li>
                            <li>Click <strong>"+ Add location"</strong> â†’ type <strong>"Johor Bahru"</strong> â†’ set radius to <strong>25 km</strong></li>
                            <li>Under <strong>Detailed Targeting</strong>, add: Homeowners, Home improvement, Interior design</li>
                            <li>Under <strong>Age</strong>: set to <strong>28-65</strong> (homeowners only, not students)</li>
                        </ol>
                    </div>
                    <div class="test-card" style="padding:14px;border-left:4px solid #4CAF50">
                        <h5 style="color:#4CAF50;margin-bottom:8px">ğŸ“ Google My Business</h5>
                        <ol style="color:#ccc;font-size:12px;padding-left:16px;line-height:1.8">
                            <li>Go to <a href="https://business.google.com" target="_blank" style="color:#4CAF50">Google Business Profile</a></li>
                            <li><strong>Info</strong> â†’ Service Area â†’ set to: <strong>Singapore</strong> and <strong>Johor Bahru</strong></li>
                            <li>This ensures Google shows you only to people searching in SG/JB</li>
                        </ol>
                    </div>
                    <div class="test-card" style="padding:14px;border-left:4px solid #FF9800">
                        <h5 style="color:#FF9800;margin-bottom:8px">ğŸ¬ TikTok / Reels Location Tags</h5>
                        <ol style="color:#ccc;font-size:12px;padding-left:16px;line-height:1.8">
                            <li>Always tag location: <strong>"Singapore"</strong> or <strong>"Johor Bahru"</strong> on every post</li>
                            <li>Use local hashtags: <strong>#singapore #sglife #hdb #jb #johorbahru #iskandar</strong></li>
                            <li>Mention neighborhoods in captions: "Tampines HDB", "JB condo", "Woodlands flat"</li>
                            <li>This signals the algorithm to show your content to local viewers</li>
                        </ol>
                    </div>
                    <div class="test-card" style="padding:14px;border-left:4px solid #E91E63">
                        <h5 style="color:#E91E63;margin-bottom:8px">ğŸ’¡ Pro Tip: Two Separate Campaigns</h5>
                        <p style="color:#ccc;font-size:12px;line-height:1.6">Run <strong>2 separate ad campaigns</strong> â€” one for SG, one for JB. Different pricing (SGD vs RM), different messaging, different audiences. This lets you optimize each market independently and gives cleaner data on which market performs better. Use the geo-targeted templates in the "Ad Templates" tab.</p>
                    </div>
                </div>

                <h4 style="margin:24px 0 12px">${getCurrentSeason().emoji} Active Campaign: ${getCurrentSeason().label}</h4>
                <div class="test-card" style="padding:14px;border-left:4px solid #4CAF50;margin-bottom:24px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-size:14px;font-weight:700;color:#fff">${getCurrentSeason().emoji} ${getCurrentSeason().label}</div>
                            <div style="font-size:12px;color:#aaa;margin-top:4px">Discount: <strong style="color:#4CAF50">${getCurrentSeason().discount}</strong> Â· Code: <strong>${getCurrentSeason().code}</strong> Â· Ends: ${getCurrentSeason().end}</div>
                        </div>
                        <span style="background:#4CAF50;color:#fff;padding:4px 12px;border-radius:4px;font-size:11px;font-weight:700">ACTIVE</span>
                    </div>
                    <p style="color:#777;font-size:11px;margin-top:8px">All templates in the "Ad Templates" tab auto-use this campaign. When the season changes, messaging updates automatically.</p>
                </div>

                <h4 style="margin:24px 0 12px">ğŸ¤– Post-Job Automation Sequence</h4>
                <p style="color:#777;font-size:12px;margin-bottom:12px">After every completed job, follow this sequence. Templates are in the "Ad Templates" tab under "â­ Review Automation" and "ğŸ” Referral Engine".</p>
                <div style="display:grid;gap:6px;margin-bottom:24px">
                    <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:12px">
                        <span style="background:#4CAF50;color:#fff;font-size:10px;padding:3px 8px;border-radius:3px;font-weight:700;min-width:50px;text-align:center">Day 0</span>
                        <div>
                            <div style="font-size:12px;color:#fff;font-weight:600">Complete job + send referral message</div>
                            <div style="font-size:10px;color:#666">Template: "Post-Job Referral Message"</div>
                        </div>
                    </div>
                    <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:12px">
                        <span style="background:#2196F3;color:#fff;font-size:10px;padding:3px 8px;border-radius:3px;font-weight:700;min-width:50px;text-align:center">Day 1</span>
                        <div>
                            <div style="font-size:12px;color:#fff;font-weight:600">Send Google Review request</div>
                            <div style="font-size:10px;color:#666">Template: "Google Review Request (Day 1)"</div>
                        </div>
                    </div>
                    <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:12px">
                        <span style="background:#FF9800;color:#fff;font-size:10px;padding:3px 8px;border-radius:3px;font-weight:700;min-width:50px;text-align:center">Day 3</span>
                        <div>
                            <div style="font-size:12px;color:#fff;font-weight:600">Review nudge (if no review yet)</div>
                            <div style="font-size:10px;color:#666">Template: "Review Nudge (Day 3)"</div>
                        </div>
                    </div>
                    <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:12px">
                        <span style="background:#9C27B0;color:#fff;font-size:10px;padding:3px 8px;border-radius:3px;font-weight:700;min-width:50px;text-align:center">Day 7</span>
                        <div>
                            <div style="font-size:12px;color:#fff;font-weight:600">Ask for before/after photo permission</div>
                            <div style="font-size:10px;color:#666">Template: "Photo Request (Day 7)" â€” offer $20 voucher</div>
                        </div>
                    </div>
                    <div class="test-card" style="padding:10px;display:flex;align-items:center;gap:12px">
                        <span style="background:#E91E63;color:#fff;font-size:10px;padding:3px 8px;border-radius:3px;font-weight:700;min-width:50px;text-align:center">Day 14</span>
                        <div>
                            <div style="font-size:12px;color:#fff;font-weight:600">Send referral reminder</div>
                            <div style="font-size:10px;color:#666">Template: "Referral Reminder (2 weeks later)"</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateAdCopyDropdown() {
            const sel = document.getElementById('leadAdCopy');
            const activeTests = tests.filter(t => t.status === 'running');
            sel.innerHTML = '<option value="">â€” Not from a test â€”</option>' +
                activeTests.map(t => `
                <option value="${t.id}_A">${t.name} â€” Variant A</option>
                <option value="${t.id}_B">${t.name} â€” Variant B</option>
            `).join('');
        }

        // ============================
        // ACTIONS
        // ============================
        function openModal() { document.getElementById('leadModal').classList.add('open'); }
        function closeModal() { document.getElementById('leadModal').classList.remove('open'); }
        function createNewTest() { document.getElementById('abModal').classList.add('open'); }
        function closeABModal() { document.getElementById('abModal').classList.remove('open'); }

        function saveLead() {
            const lead = {
                name: document.getElementById('leadName').value || 'Unknown',
                phone: document.getElementById('leadPhone').value,
                channel: document.getElementById('leadChannel').value,
                adCopy: document.getElementById('leadAdCopy').value,
                package: document.getElementById('leadPackage').value,
                status: document.getElementById('leadStatus').value,
                notes: document.getElementById('leadNotes').value,
                date: new Date().toISOString()
            };
            leads.push(lead);
            setData('leads', leads);

            // Update A/B test counts
            if (lead.adCopy) {
                const [testId, variant] = lead.adCopy.split('_');
                const test = tests.find(t => t.id == testId);
                if (test) {
                    if (variant === 'A') { test.leadsA++; if (lead.status === 'Booked' || lead.status === 'Hot') test.convA++; }
                    if (variant === 'B') { test.leadsB++; if (lead.status === 'Booked' || lead.status === 'Hot') test.convB++; }
                    setData('tests', tests);
                }
            }

            closeModal();
            document.getElementById('leadName').value = '';
            document.getElementById('leadPhone').value = '';
            document.getElementById('leadNotes').value = '';
            render();
        }

        function updateLeadStatus(idx, status) {
            const oldStatus = leads[idx].status;
            leads[idx].status = status;
            setData('leads', leads);

            // Update A/B test conversion if changing to/from Booked/Hot
            if (leads[idx].adCopy) {
                const [testId, variant] = leads[idx].adCopy.split('_');
                const test = tests.find(t => t.id == testId);
                if (test) {
                    const wasConv = oldStatus === 'Booked' || oldStatus === 'Hot';
                    const isConv = status === 'Booked' || status === 'Hot';
                    if (!wasConv && isConv) { if (variant === 'A') test.convA++; else test.convB++; }
                    if (wasConv && !isConv) { if (variant === 'A') test.convA = Math.max(0, test.convA - 1); else test.convB = Math.max(0, test.convB - 1); }
                    setData('tests', tests);
                }
            }
            render();
        }

        function saveTest() {
            const test = {
                id: Date.now(),
                name: document.getElementById('testName').value || 'Untitled Test',
                channel: document.getElementById('testChannel').value,
                status: 'running',
                copyA: document.getElementById('testCopyA').value,
                copyB: document.getElementById('testCopyB').value,
                leadsA: 0, leadsB: 0, convA: 0, convB: 0,
                minLeads: parseInt(document.getElementById('testMinLeads').value),
                winner: null
            };
            tests.push(test);
            setData('tests', tests);
            closeABModal();
            switchTab('ab');
        }

        function exportData() {
            const csvEsc = s => `"${String(s || '').replace(/"/g, '""')}"`;
            const csv = 'Date,Name,Phone,Channel,Ad Copy,Package,Status,Notes\n' +
                leads.map(l => [l.date, csvEsc(l.name), csvEsc(l.phone), l.channel, csvEsc(l.adCopy), l.package, l.status, csvEsc(l.notes)].join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'cleangrout_leads_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function deleteLead(idx) {
            if (!confirm('Delete this lead?')) return;
            leads.splice(idx, 1);
            setData('leads', leads);
            render();
        }

        // HTML escape to prevent XSS
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        // Close modals on backdrop click or Escape
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
        });
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
        });

        // Auto-import chatbot leads
        function importChatbotLeads() {
            const chatLeads = JSON.parse(localStorage.getItem('cleangrout_leads') || '[]');
            chatLeads.forEach(cl => {
                if (!leads.find(l => l.phone === cl.phone && l.name === cl.name)) {
                    leads.push({
                        name: cl.name, phone: cl.phone, channel: 'Website',
                        adCopy: '', package: cl.package || 'Unsure', status: 'Warm',
                        notes: 'Auto-imported from chatbot', date: cl.timestamp
                    });
                }
            });
            setData('leads', leads);
        }

        // Init
        importChatbotLeads();
        render();
    </script>
</body>

</html>